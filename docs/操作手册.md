# Dameng Exporter 操作手册

## 目录
- [系统要求](#系统要求)
- [安装部署](#安装部署)
- [配置说明](#配置说明)
- [关键参数详解](#关键参数详解)
- [启动与验证](#启动与验证)
- [常见问题](#常见问题)
- [故障排查](#故障排查)

## 系统要求

### 软件要求
- **达梦数据库**：DM8 或以上版本
- **操作系统**：
  - Linux（CentOS 7+、Ubuntu 18.04+、RHEL 7+）
  - Windows Server 2012+
  - 支持 ARM64 和 AMD64 架构
- **监控组件**：
  - Prometheus 2.0+
  - Grafana 8.5+（可选，用于可视化）

### 硬件要求
- **CPU**：最低 1 核，建议 2 核以上
- **内存**：最低 512MB，建议 1GB 以上
- **磁盘**：100MB 安装空间 + 日志存储空间
- **网络**：能够访问达梦数据库实例

## 安装部署

### 方式一：二进制文件安装（推荐）

#### 1. 下载程序

```bash
# Linux AMD64
wget https://github.com/gaoyuan98/dameng_exporter/releases/download/v1.2.0/dameng_exporter_v1.2.0_linux_amd64.tar.gz
tar -xzf dameng_exporter_v1.2.0_linux_amd64.tar.gz
cd dameng_exporter

# Linux ARM64
wget https://github.com/gaoyuan98/dameng_exporter/releases/download/v1.2.0/dameng_exporter_v1.2.0_linux_arm64.tar.gz
tar -xzf dameng_exporter_v1.2.0_linux_arm64.tar.gz
cd dameng_exporter

# Windows
# 下载 dameng_exporter_v1.2.0_windows_amd64.tar.gz
# 使用 7-Zip 或 WinRAR 解压
```

#### 2. 设置执行权限（Linux）

```bash
chmod +x dameng_exporter
```

#### 3. 创建配置文件

```bash
# 创建配置文件
cat > dameng_exporter.toml << 'EOF'
# 服务配置
listenAddress = ":9200"
metricPath = "/metrics"

# 日志配置
logLevel = "info"
logMaxSize = 10
logMaxBackups = 3
logMaxAge = 30

# 性能配置
globalTimeoutSeconds = 5
collectionMode = "blocking"

# 数据源配置
[[datasource]]
name = "dm_main"
description = "主数据库"
enabled = true
dbHost = "192.168.1.100:5236"
dbUser = "SYSDBA"
dbPwd = "SYSDBA"
queryTimeout = 30
maxOpenConns = 10
maxIdleConns = 2
connMaxLifetime = 30
registerDatabaseMetrics = true
EOF
```

### 方式二：Docker 部署

#### 1. 拉取镜像

```bash
# AMD64 架构
docker pull registry.cn-hangzhou.aliyuncs.com/dameng_exporter/dameng_exporter:v1.2.0_amd64

# ARM64 架构
docker pull registry.cn-hangzhou.aliyuncs.com/dameng_exporter/dameng_exporter:v1.2.0_arm64
```

#### 2. 运行容器

```bash
# 使用配置文件
docker run -d \
  --name dameng_exporter \
  -p 9200:9200 \
  -v $(pwd)/dameng_exporter.toml:/app/dameng_exporter.toml \
  -v $(pwd)/logs:/app/logs \
  --restart=always \
  registry.cn-hangzhou.aliyuncs.com/dameng_exporter/dameng_exporter:v1.2.0_amd64

# 使用命令行参数
docker run -d \
  --name dameng_exporter \
  -p 9200:9200 \
  --restart=always \
  registry.cn-hangzhou.aliyuncs.com/dameng_exporter/dameng_exporter:v1.2.0_amd64 \
  --dbHost="192.168.1.100:5236" \
  --dbUser="SYSDBA" \
  --dbPwd="YourPassword"
```

### 方式三：从源码编译

#### 1. 安装 Go 环境

```bash
# 下载 Go 1.19+
wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin
```

#### 2. 编译程序

```bash
# 克隆代码
git clone https://github.com/gaoyuan98/dameng_exporter.git
cd dameng_exporter

# 编译
go build -o dameng_exporter main.go

# Windows 编译
# 使用提供的批处理脚本
./build_all_versions.bat
```

### 方式四：systemd 服务部署（Linux）

#### 1. 创建服务文件

```bash
sudo vim /etc/systemd/system/dameng_exporter.service
```

内容如下：

```ini
[Unit]
Description=Dameng Database Exporter
After=network.target

[Service]
Type=simple
User=prometheus
Group=prometheus
WorkingDirectory=/opt/dameng_exporter
ExecStart=/opt/dameng_exporter/dameng_exporter --configFile=/opt/dameng_exporter/dameng_exporter.toml
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

#### 2. 启动服务

```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start dameng_exporter

# 设置开机自启
sudo systemctl enable dameng_exporter

# 查看状态
sudo systemctl status dameng_exporter
```

## 配置说明

### 配置文件结构

```toml
# ========== 全局配置 ==========
listenAddress = ":9200"           # 监听地址
metricPath = "/metrics"           # 指标路径
logLevel = "info"                 # 日志级别：debug|info|warn|error
logMaxSize = 10                   # 日志文件大小（MB）
logMaxBackups = 3                 # 日志备份数量
logMaxAge = 30                    # 日志保留天数
encodeConfigPwd = true            # 自动加密配置文件中的密码
enableBasicAuth = false           # 启用 Basic Auth
basicAuthUsername = "admin"       # Basic Auth 用户名
basicAuthPassword = "password"    # Basic Auth 密码
globalTimeoutSeconds = 5          # 全局超时（秒）
collectionMode = "blocking"       # 采集模式：blocking|fast

# ========== 数据源配置 ==========
[[datasource]]
name = "dm_prod"                  # 数据源名称（必填，唯一）
description = "生产环境数据库"      # 描述信息
enabled = true                    # 是否启用
dbHost = "192.168.1.100:5236"    # 数据库地址:端口
dbUser = "SYSDBA"                 # 数据库用户
dbPwd = "SYSDBA"                  # 数据库密码
queryTimeout = 30                 # 查询超时（秒）
maxOpenConns = 10                 # 最大连接数
maxIdleConns = 2                  # 最大空闲连接数
connMaxLifetime = 30              # 连接生命周期（分钟）
bigKeyDataCacheTime = 60          # 大数据缓存时间（分钟）
alarmKeyCacheTime = 5             # 告警缓存时间（分钟）
checkSlowSQL = true               # 检查慢SQL
slowSqlTime = 5000                # 慢SQL阈值（毫秒）
slowSqlMaxRows = 20               # 慢SQL返回行数
registerHostMetrics = true        # 采集主机指标
registerDatabaseMetrics = true    # 采集数据库指标
registerDmhsMetrics = false       # 采集DMHS指标
registerCustomMetrics = true      # 采集自定义指标
labels = "env=prod,region=cn"     # 附加标签
customMetricsFile = "./custom.toml" # 自定义指标文件

# 可以配置多个数据源
[[datasource]]
name = "dm_test"
# ... 其他配置
```

### 数据库用户权限配置

在达梦数据库中创建监控用户：

```sql
-- 创建表空间
CREATE TABLESPACE "PROMETHEUS" DATAFILE 'PROMETHEUS.DBF' SIZE 512 CACHE = NORMAL;

-- 创建用户
CREATE USER "PROMETHEUS" IDENTIFIED BY "Prometheus@123";
ALTER USER "PROMETHEUS" DEFAULT TABLESPACE "PROMETHEUS";

-- 方式1：授予 DBA 权限（简单）
GRANT DBA TO "PROMETHEUS";

-- 方式2：最小权限授予（推荐）
GRANT "PUBLIC","RESOURCE","SOI","SVI","VTI" TO "PROMETHEUS";

-- 授予必要的系统视图权限
GRANT SELECT ON V$SYSSTAT TO PROMETHEUS;
GRANT SELECT ON V$SESSIONS TO PROMETHEUS;
GRANT SELECT ON V$LICENSE TO PROMETHEUS;
GRANT SELECT ON V$DATABASE TO PROMETHEUS;
GRANT SELECT ON V$DM_INI TO PROMETHEUS;
GRANT SELECT ON V$RLOGFILE TO PROMETHEUS;
GRANT SELECT ON V$TABLESPACE TO PROMETHEUS;
GRANT SELECT ON V$DATAFILE TO PROMETHEUS;
GRANT SELECT ON DBA_DATA_FILES TO PROMETHEUS;
GRANT SELECT ON DBA_FREE_SPACE TO PROMETHEUS;
GRANT SELECT ON V$TRXWAIT TO PROMETHEUS;
GRANT SELECT ON V$CKPT TO PROMETHEUS;
GRANT SELECT ON V$RAPPLY_SYS TO PROMETHEUS;
GRANT SELECT ON V$RAPPLY_STAT TO PROMETHEUS;
GRANT SELECT ON V$PROCESS TO PROMETHEUS;
GRANT SELECT ON V$LOCK TO PROMETHEUS;
GRANT SELECT ON V$THREADS TO PROMETHEUS;
GRANT SELECT ON V$INSTANCE_LOG_HISTORY TO PROMETHEUS;
GRANT SELECT ON V$ARCH_FILE TO PROMETHEUS;
GRANT SELECT ON V$DMWATCHER TO PROMETHEUS;
GRANT SELECT ON V$INSTANCE TO PROMETHEUS;
GRANT SELECT ON V$BUFFERPOOL TO PROMETHEUS;
GRANT SELECT ON V$ARCH_SEND_INFO TO PROMETHEUS;
GRANT SELECT ON V$ARCH_STATUS TO PROMETHEUS;
GRANT SELECT ON V$ARCH_APPLY_INFO TO PROMETHEUS;
GRANT SELECT ON V$PURGE TO PROMETHEUS;
GRANT SELECT ON V$DYNAMIC_TABLES TO PROMETHEUS;
GRANT SELECT ON V$DYNAMIC_TABLE_COLUMNS TO PROMETHEUS;
```

## 关键参数详解

### 采集模式参数

#### collectionMode（采集模式）
- **blocking**（默认）：阻塞模式，等待所有采集器完成
  - 优点：确保数据完整性，不丢失任何指标
  - 缺点：响应时间取决于最慢的采集器
  - 适用：正常监控场景
  - 注意：此模式下 `globalTimeoutSeconds` 不生效

- **fast**：快速模式，受全局超时控制
  - 优点：保证响应时间
  - 缺点：可能返回部分数据
  - 适用：对响应时间要求严格的场景
  - 配置：通过 `globalTimeoutSeconds` 控制超时

#### globalTimeoutSeconds（全局超时）
- **作用**：控制整体采集的最大等待时间
- **默认值**：5 秒
- **生效条件**：仅在 `collectionMode=fast` 时生效
- **建议值**：
  - 局域网环境：3-5 秒
  - 跨地域部署：5-10 秒
  - 大型数据库：10-30 秒

#### queryTimeout（查询超时）
- **作用**：单个 SQL 查询的超时时间
- **默认值**：30 秒
- **生效条件**：始终生效，独立于采集模式
- **建议值**：
  - 简单查询：10-20 秒
  - 复杂统计：30-60 秒
  - 慢查询监控：60-120 秒

### 连接池参数

#### maxOpenConns（最大连接数）
- **作用**：限制到数据库的最大并发连接数
- **默认值**：10
- **建议值**：
  - 小型数据库：5-10
  - 中型数据库：10-20
  - 大型数据库：20-50
- **注意**：过大会占用数据库连接资源

#### maxIdleConns（最大空闲连接）
- **作用**：保持的空闲连接数
- **默认值**：2
- **建议值**：maxOpenConns 的 20-30%
- **优化**：减少连接建立开销

#### connMaxLifetime（连接生命周期）
- **作用**：连接的最大生存时间
- **默认值**：30 分钟
- **建议值**：
  - 稳定网络：30-60 分钟
  - 不稳定网络：10-20 分钟
- **目的**：防止连接长时间占用

### 缓存参数

#### bigKeyDataCacheTime（大数据缓存）
- **作用**：缓存大数据量查询结果
- **默认值**：60 分钟
- **适用指标**：
  - 表空间信息
  - 数据文件信息
  - 用户列表
- **优化**：减少对数据库的压力

#### alarmKeyCacheTime（告警缓存）
- **作用**：缓存告警相关数据
- **默认值**：5 分钟
- **适用指标**：
  - 错误日志
  - 慢 SQL
  - 锁等待
- **平衡**：及时性与性能的平衡

### 慢 SQL 参数

#### checkSlowSQL（启用慢 SQL 监控）
- **默认值**：false
- **影响**：开启后会定期查询慢 SQL 信息
- **注意**：可能增加数据库负载

#### slowSqlTime（慢 SQL 阈值）
- **作用**：定义慢 SQL 的时间阈值
- **默认值**：10000 毫秒（10 秒）
- **建议值**：
  - OLTP 系统：1000-5000 毫秒
  - OLAP 系统：10000-30000 毫秒

#### slowSqlMaxRows（返回行数限制）
- **作用**：限制慢 SQL 返回的最大行数
- **默认值**：10
- **建议值**：10-50
- **目的**：防止返回过多数据

## 启动与验证

### 启动程序

#### 使用配置文件启动

```bash
# Linux/Mac
./dameng_exporter --configFile=dameng_exporter.toml

# 后台运行
nohup ./dameng_exporter --configFile=dameng_exporter.toml > /dev/null 2>&1 &

# Windows
dameng_exporter.exe --configFile=dameng_exporter.toml
```

#### 使用命令行参数启动

```bash
./dameng_exporter \
  --dbHost="192.168.1.100:5236" \
  --dbUser="PROMETHEUS" \
  --dbPwd="YourPassword" \
  --collectionMode="blocking" \
  --queryTimeout=30 \
  --logLevel="info"
```

### 验证服务

#### 1. 检查服务状态

```bash
# 检查进程
ps aux | grep dameng_exporter

# 检查端口
netstat -tlnp | grep 9200

# 查看日志
tail -f logs/dameng_exporter_$(date +%Y-%m-%d).log
```

#### 2. 访问指标端点

```bash
# 使用 curl 测试
curl http://localhost:9200/metrics

# 检查特定指标
curl http://localhost:9200/metrics | grep dmdbms_up

# 格式化输出
curl -s http://localhost:9200/metrics | grep -E "^dmdbms_" | head -20
```

#### 3. 验证数据库连接

成功连接后，应该看到 `dmdbms_up` 指标值为 1：

```
dmdbms_up{datasource="dm_main"} 1
```

### 配置 Prometheus

#### 1. 编辑 prometheus.yml

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'dameng'
    scrape_interval: 30s
    scrape_timeout: 10s
    static_configs:
      - targets: ['192.168.1.100:9200']
        labels:
          instance: 'dm_prod'
          env: 'production'
```

#### 2. 重载配置

```bash
# 使用信号重载
kill -HUP $(pidof prometheus)

# 或使用 API
curl -X POST http://localhost:9090/-/reload
```

#### 3. 验证采集

访问 Prometheus Web UI（http://localhost:9090），执行查询：

```promql
# 检查目标状态
up{job="dameng"}

# 查看数据库启动时间
dmdbms_start_time_info
```

### 导入 Grafana 面板

#### 1. 登录 Grafana

默认地址：http://localhost:3000
默认账号：admin/admin

#### 2. 添加数据源

1. 进入 Configuration → Data Sources
2. 点击 Add data source
3. 选择 Prometheus
4. 配置 URL：http://localhost:9090
5. 点击 Save & Test

#### 3. 导入面板

1. 进入 Dashboards → Import
2. 上传文件：`docs/达梦DB监控面板_20250518.json`
3. 选择 Prometheus 数据源
4. 点击 Import

## 常见问题

### Q1：连接数据库失败

**错误信息**：
```
Error: Failed to connect to database: dial tcp: connection refused
```

**解决方案**：
1. 检查数据库服务是否启动
2. 确认 IP 地址和端口正确
3. 检查防火墙设置
4. 验证网络连通性：`telnet 192.168.1.100 5236`

### Q2：权限不足

**错误信息**：
```
Error: insufficient privileges
```

**解决方案**：
1. 确认用户具有必要的权限
2. 执行权限授予 SQL
3. 检查表空间配额

### Q3：指标采集超时

**错误信息**：
```
WARN: Collector timeout after 30s
```

**解决方案**：
1. 增加 `queryTimeout` 参数值
2. 优化数据库性能
3. 使用 `fast` 采集模式
4. 调整 `globalTimeoutSeconds`

### Q4：内存占用过高

**现象**：
程序内存持续增长

**解决方案**：
1. 减少 `maxOpenConns` 值
2. 调整缓存时间参数
3. 关闭不必要的指标采集
4. 检查是否有内存泄漏

### Q5：日志文件过大

**解决方案**：
1. 调整 `logLevel` 为 `warn` 或 `error`
2. 减小 `logMaxSize` 值
3. 减少 `logMaxBackups` 数量
4. 定期清理旧日志

## 故障排查

### 检查清单

#### 1. 基础检查
- [ ] 服务进程是否运行
- [ ] 端口是否监听
- [ ] 配置文件是否正确
- [ ] 日志是否有错误

#### 2. 网络检查
- [ ] 能否 ping 通数据库服务器
- [ ] 能否 telnet 数据库端口
- [ ] 防火墙规则是否正确
- [ ] DNS 解析是否正常

#### 3. 数据库检查
- [ ] 数据库服务是否正常
- [ ] 监听器是否启动
- [ ] 用户密码是否正确
- [ ] 用户权限是否足够

#### 4. 性能检查
- [ ] CPU 使用率
- [ ] 内存使用情况
- [ ] 磁盘 I/O
- [ ] 网络延迟

### 日志分析

#### 日志位置
```
logs/dameng_exporter_YYYY-MM-DD.log
```

#### 日志级别
- **DEBUG**：详细调试信息
- **INFO**：正常运行信息
- **WARN**：警告信息
- **ERROR**：错误信息

#### 关键日志解读

```
# 启动成功
INFO: Starting dameng_exporter version v1.2.0

# 连接成功
INFO: Successfully created pool for datasource

# 采集完成
INFO: [dm_main] DbVersion completed (blocking mode) | Cost: 147ms | Metrics: 1

# 连接失败
ERROR: Failed to initialize datasource pools

# 查询超时
WARN: Query timeout after 30s
```

### 性能优化建议

#### 1. 网络优化
- 将 Exporter 部署在数据库同机房
- 使用内网 IP 而非域名
- 启用连接池复用

#### 2. 查询优化
- 关闭不需要的指标采集
- 增加缓存时间
- 使用 fast 模式

#### 3. 资源优化
- 合理设置连接池大小
- 调整日志级别
- 定期重启服务释放资源

## 高级配置

### 配置 Basic Auth

#### 1. 生成加密密码

```bash
./dameng_exporter --encryptBasicAuthPwd="YourPassword"
# 输出: $2a$12$xxxxxxxxxxxxx
```

#### 2. 更新配置

```toml
enableBasicAuth = true
basicAuthUsername = "admin"
basicAuthPassword = "$2a$12$xxxxxxxxxxxxx"
```

#### 3. 配置 Prometheus

```yaml
scrape_configs:
  - job_name: 'dameng'
    basic_auth:
      username: 'admin'
      password: 'YourPassword'
    static_configs:
      - targets: ['192.168.1.100:9200']
```

### 配置自定义指标

#### 1. 创建配置文件

```toml
# custom_metrics.toml
[[metric]]
context = "custom_tablespace"
request = "SELECT tablespace_name, used_mb, total_mb FROM dba_tablespaces"
labels = ["tablespace_name"]
metricsdesc = { 
  used_mb = "Used space in MB",
  total_mb = "Total space in MB" 
}

# 高级选项：过滤零值
[[metric]]
context = "user_errors"
request = "SELECT username, error_count FROM v$user_errors"
labels = ["username"]
metricsdesc = { error_count = "User error count" }
ignorezeroresult = true  # 只显示有错误的用户，过滤掉 error_count=0 的记录
```

#### 2. 启用自定义指标

```toml
registerCustomMetrics = true
customMetricsFile = "./custom_metrics.toml"
```

#### 3. ignorezeroresult 参数说明

`ignorezeroresult` 是自定义指标的可选参数，用于优化稀疏数据的监控：

**作用**：
- 过滤掉值为 0 的指标数据
- 减少 Prometheus 中的时间序列数量
- 优化存储空间和查询性能

**适用场景**：
- 监控用户活动（大量用户但只有少数活跃）
- 错误统计（只关注有错误的模块）
- 事件监控（只记录发生的事件）

**示例对比**：
```bash
# 不使用 ignorezeroresult（默认）
dmdbms_user_errors_error_count{username="user1"} 5
dmdbms_user_errors_error_count{username="user2"} 0
dmdbms_user_errors_error_count{username="user3"} 0
dmdbms_user_errors_error_count{username="user4"} 2

# 使用 ignorezeroresult = true
dmdbms_user_errors_error_count{username="user1"} 5
dmdbms_user_errors_error_count{username="user4"} 2
# user2 和 user3 的零值被过滤掉
```

### 配置告警规则

#### 1. 创建告警规则文件

```yaml
# dameng_alerts.yml
groups:
  - name: dameng
    rules:
      - alert: DamengDown
        expr: dmdbms_up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Dameng database is down"
          
      - alert: HighSessionUsage
        expr: dmdbms_session_percentage > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Session usage is above 80%"
```

#### 2. 配置 Prometheus

```yaml
rule_files:
  - "dameng_alerts.yml"
```

## 附录

### 支持的指标列表

| 指标名称 | 类型 | 说明 |
|---------|------|------|
| dmdbms_up | Gauge | 数据库是否可用 |
| dmdbms_start_time_info | Gauge | 数据库启动时间 |
| dmdbms_session_percentage | Gauge | 会话使用率 |
| dmdbms_tablespace_usage_percentage | Gauge | 表空间使用率 |
| dmdbms_memory_curr_pool_info | Gauge | 内存池使用情况 |
| dmdbms_buffer_pool_hit_ratio | Gauge | 缓冲池命中率 |
| dmdbms_slow_sql_info | Counter | 慢SQL统计 |
| dmdbms_arch_status_info | Gauge | 归档状态 |
| dmdbms_rapply_time_diff | Gauge | 主备延迟时间 |

### 端口说明

| 端口 | 用途 | 说明 |
|------|------|------|
| 9200 | Exporter | 指标暴露端口 |
| 5236 | DM数据库 | 默认监听端口 |
| 9090 | Prometheus | 默认Web端口 |
| 3000 | Grafana | 默认Web端口 |

### 相关链接

- [项目主页](https://github.com/gaoyuan98/dameng_exporter)
- [问题反馈](https://github.com/gaoyuan98/dameng_exporter/issues)
- [达梦官网](https://www.dameng.com)
- [Prometheus 文档](https://prometheus.io/docs)
- [Grafana 文档](https://grafana.com/docs)

---

**版本**：v1.2.0  
**更新日期**：2025-01-03  
**维护团队**：达梦课代表

如有问题，请关注微信公众号「达梦课代表」获取技术支持。