# ================================================================================
# è¾¾æ¢¦æ•°æ®åº“è‡ªå®šä¹‰æŸ¥è¯¢æŒ‡æ ‡å®šä¹‰æ–‡ä»¶
# DamEng Database Custom Query Metrics Definition
# ================================================================================
# 
# æ–‡ä»¶è¯´æ˜ï¼š
# - æ–‡ä»¶ç±»å‹ï¼šTOMLæ ¼å¼çš„è‡ªå®šä¹‰SQLæŸ¥è¯¢å®šä¹‰æ–‡ä»¶
# - æ–‡ä»¶æ‰©å±•åï¼š.metrics (åŒºåˆ«äºé…ç½®æ–‡ä»¶çš„.toml/.config)
# - é»˜è®¤ä½ç½®ï¼šä¸dameng_exporterç¨‹åºåŒçº§ç›®å½•
# - é…ç½®å¼•ç”¨ï¼šåœ¨dameng_exporter.tomlä¸­é€šè¿‡customMetricsFileå‚æ•°æŒ‡å®š
# ================================================================================
# æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0
# æ›´æ–°æ—¥æœŸï¼š2025-09-02
# é€‚ç”¨ç‰ˆæœ¬ï¼šdameng_exporter v1.2.0
# ================================================================================

# ================================================================================
# ğŸ“š ä½¿ç”¨è¯´æ˜
# ================================================================================
# 
# 1. åŸºæœ¬ç»“æ„ï¼š
#    æ¯ä¸ª [[metric]] æ®µå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰æŸ¥è¯¢ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
#    - context: æŒ‡æ ‡ä¸Šä¸‹æ–‡åç§°ï¼ˆå¿…éœ€ï¼‰
#    - labels: æ ‡ç­¾å­—æ®µæ•°ç»„ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºç©ºæ•°ç»„ï¼‰
#    - request: SQLæŸ¥è¯¢è¯­å¥ï¼ˆå¿…éœ€ï¼‰
#    - metricsdesc: å­—æ®µæè¿°æ˜ å°„ï¼ˆå¿…éœ€ï¼Œå†…è”è¡¨æ ¼å¼ï¼‰
#    - metricstype: å­—æ®µç±»å‹æ˜ å°„ï¼ˆå¿…éœ€ï¼Œå†…è”è¡¨æ ¼å¼ï¼‰
#
# 2. æŒ‡æ ‡å‘½åè§„åˆ™ï¼š
#    æœ€ç»ˆç”Ÿæˆçš„PrometheusæŒ‡æ ‡åæ ¼å¼ï¼šdmdbms_<context>_<field>
#    ä¾‹å¦‚ï¼šcontext="session_summary", field="active_count" 
#    ç”Ÿæˆï¼šdmdbms_session_summary_active_count
#
# 3. æ ‡ç­¾(Labels)è¯´æ˜ï¼š
#    - labelsæ•°ç»„ä¸­çš„å­—æ®µä¼šä½œä¸ºPrometheusæ ‡ç­¾ï¼Œä¸ä¼šä½œä¸ºæŒ‡æ ‡å€¼
#    - æ‰€æœ‰æŒ‡æ ‡è‡ªåŠ¨åŒ…å«datasourceæ ‡ç­¾ï¼ˆæ ‡è¯†æ•°æ®æºï¼‰
#    - æ ‡ç­¾å€¼æ¥è‡ªSQLæŸ¥è¯¢ç»“æœçš„å¯¹åº”åˆ—
#
# 4. æŒ‡æ ‡ç±»å‹(metricstype)ï¼š
#    - gauge: ä»ªè¡¨ç›˜ç±»å‹ï¼Œç¬æ—¶å€¼ï¼Œå¯å¢å¯å‡ï¼ˆå¦‚ï¼šå½“å‰è¿æ¥æ•°ã€CPUä½¿ç”¨ç‡ï¼‰
#    - counter: è®¡æ•°å™¨ç±»å‹ï¼Œç´¯è®¡å€¼ï¼Œåªå¢ä¸å‡ï¼ˆå¦‚ï¼šè¯·æ±‚æ€»æ•°ã€é”™è¯¯æ€»æ•°ï¼‰
#
# 5. é‡è¦æ³¨æ„äº‹é¡¹ï¼š
#    âš ï¸ metricsdescå’Œmetricstypeå¿…é¡»ä½¿ç”¨å†…è”è¡¨æ ¼å¼ï¼ˆå†™åœ¨ä¸€è¡Œï¼‰
#    âš ï¸ SQLæŸ¥è¯¢ç»“æœçš„åˆ—åä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå°å†™
#    âš ï¸ åªæœ‰æ•°å€¼ç±»å‹çš„åˆ—æ‰ä¼šä½œä¸ºæŒ‡æ ‡å€¼å¯¼å‡º
#    âš ï¸ é‡å¯dameng_exporteråé…ç½®æ‰ä¼šç”Ÿæ•ˆ
#
# ================================================================================

# ================================================================================
# æµ‹è¯•ç”¨ä¾‹1: ç®€å•è¯­å¥æµ‹è¯•ï¼ˆå¸¦æ ‡ç­¾ï¼‰
# è¯´æ˜ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ ‡ç­¾æ¥åŒºåˆ†ä¸åŒç»´åº¦çš„æŒ‡æ ‡
# ================================================================================
[[metric]]
context = "context_with_labels"
labels = ["label_1", "label_2"]
request = "SELECT 1 as value_1, 2 as value_2, 'First label' as label_1, 'Second label' as label_2 FROM DUAL"
metricsdesc = { value_1 = "Simple example returning always 1 as counter", value_2 = "Same but returning always 2 as gauge" }
metricstype = { value_1 = "counter", value_2 = "gauge" }

# ç”Ÿæˆçš„æŒ‡æ ‡ç¤ºä¾‹ï¼š
# dmdbms_context_with_labels_value_1{datasource="master",label_1="First label",label_2="Second label"} 1
# dmdbms_context_with_labels_value_2{datasource="master",label_1="First label",label_2="Second label"} 2

# ================================================================================
# æµ‹è¯•ç”¨ä¾‹2: ç®€å•è¯­å¥æµ‹è¯•ï¼ˆæ— æ ‡ç­¾ï¼‰
# è¯´æ˜ï¼šæœ€ç®€å•çš„æŒ‡æ ‡å®šä¹‰ï¼Œæ‰€æœ‰æ•°å€¼å­—æ®µéƒ½ä½œä¸ºæŒ‡æ ‡å€¼
# ================================================================================
[[metric]]
context = "context_no_label"
labels = []
request = "SELECT 1 as value_1, 2 as value_2 FROM DUAL"
metricsdesc = { value_1 = "Simple example returning always 1", value_2 = "Same but returning always 2" }
metricstype = { value_1 = "gauge", value_2 = "gauge" }

# ç”Ÿæˆçš„æŒ‡æ ‡ç¤ºä¾‹ï¼š
# # HELP dmdbms_context_no_label_value_1 Simple example returning always 1
# # TYPE dmdbms_context_no_label_value_1 gauge
# dmdbms_context_no_label_value_1{datasource="master"} 1
# # HELP dmdbms_context_no_label_value_2 Same but returning always 2
# # TYPE dmdbms_context_no_label_value_2 gauge
# dmdbms_context_no_label_value_2{datasource="master"} 2

# ================================================================================
# æµ‹è¯•ç”¨ä¾‹3: æ´»åŠ¨ä¼šè¯æ¦‚è¦
# è¯´æ˜ï¼šå¤æ‚SQLæŸ¥è¯¢ç¤ºä¾‹ï¼Œä½¿ç”¨å­æŸ¥è¯¢ç»Ÿè®¡ä¸åŒçŠ¶æ€çš„ä¼šè¯æ•°
# ================================================================================
[[metric]]
context = "session_summary"
labels = []
request = """
SELECT /*+DMDB_CHECK_FLAG*/ * FROM
( SELECT COUNT(*) ACTIVE_COUNT FROM V$SESSIONS WHERE STATE = 'ACTIVE') A,
( SELECT COUNT(*) IDLE_COUNT FROM V$SESSIONS WHERE STATE = 'IDLE' ) B,
( SELECT COUNT(*) OTHER_COUNT FROM V$SESSIONS WHERE STATE NOT IN ('IDLE', 'ACTIVE')) C,
( SELECT COUNT(*) SESSION_COUNT FROM V$SESSIONS ) D
"""
metricsdesc = { active_count = "æ´»è·ƒä¼šè¯æ•°é‡", idle_count = "ç©ºé—²ä¼šè¯æ•°é‡", other_count = "å…¶ä»–çŠ¶æ€ä¼šè¯æ•°é‡", session_count = "æ€»ä¼šè¯æ•°é‡" }
metricstype = { active_count = "gauge", idle_count = "gauge", other_count = "gauge", session_count = "gauge" }

# SQLè¯´æ˜ï¼š
# - é€šè¿‡å­æŸ¥è¯¢åˆ†åˆ«ç»Ÿè®¡ä¸åŒçŠ¶æ€çš„ä¼šè¯æ•°
# - æ‰€æœ‰è®¡æ•°å€¼éƒ½ä½¿ç”¨gaugeç±»å‹ï¼ˆå› ä¸ºä¼šè¯æ•°ä¼šå¢å‡ï¼‰
#
# ç”Ÿæˆçš„æŒ‡æ ‡ç¤ºä¾‹ï¼š
# dmdbms_session_summary_active_count{datasource="master"} 3
# dmdbms_session_summary_idle_count{datasource="master"} 5
# dmdbms_session_summary_other_count{datasource="master"} 1
# dmdbms_session_summary_session_count{datasource="master"} 9

# ================================================================================
# æµ‹è¯•ç”¨ä¾‹4: è¡¨ç©ºé—´æ•°æ®æ–‡ä»¶å¤§å°ï¼ˆæ¥è‡ªREADME.mdç¤ºä¾‹ï¼‰
# è¯´æ˜ï¼šå¸¦æ ‡ç­¾çš„å®é™…åº”ç”¨ç¤ºä¾‹ï¼Œç›‘æ§ä¸åŒè¡¨ç©ºé—´çš„å¤§å°
# ================================================================================
[[metric]]
context = "test_table_metrics"
labels = ["name"]
request = "SELECT name, TO_CHAR(TOTAL_SIZE*PAGE/1024/1024) AS total_size_mb FROM SYS.V$TABLESPACE"
metricsdesc = { total_size_mb = "Simple example" }
metricstype = { total_size_mb = "gauge" }

# SQLè¯´æ˜ï¼š
# - nameå­—æ®µä½œä¸ºæ ‡ç­¾ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„è¡¨ç©ºé—´
# - TO_CHARå‡½æ•°å°†è®¡ç®—ç»“æœè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ˆä¼šè‡ªåŠ¨è½¬ä¸ºæ•°å€¼ï¼‰
# - TOTAL_SIZE*PAGEè®¡ç®—å®é™…å­—èŠ‚æ•°ï¼Œå†è½¬æ¢ä¸ºMB
#
# ç”Ÿæˆçš„æŒ‡æ ‡ç¤ºä¾‹ï¼š
# dmdbms_test_table_metrics_total_size_mb{datasource="master",name="MAIN"} 14592
# dmdbms_test_table_metrics_total_size_mb{datasource="master",name="SYSTEM"} 340
# dmdbms_test_table_metrics_total_size_mb{datasource="master",name="ROLL"} 512
# dmdbms_test_table_metrics_total_size_mb{datasource="master",name="TEMP"} 138
