# DAMENG_EXPORTER æ“ä½œæ‰‹å†Œ

> **âš ï¸ æ³¨æ„ï¼šæœ¬æ‰‹å†Œä»åœ¨æŒç»­å®Œå–„ä¸­**  
> å½“å‰ç‰ˆæœ¬ä¸ºåˆæ­¥ç‰ˆæœ¬ï¼Œéƒ¨åˆ†å†…å®¹å¯èƒ½å­˜åœ¨ä»¥ä¸‹æƒ…å†µï¼š
> - æŸäº›é«˜çº§åŠŸèƒ½ç« èŠ‚å°šæœªå®Œå…¨è¦†ç›–
> - éƒ¨åˆ†ç¤ºä¾‹ä»£ç å¾…è¿›ä¸€æ­¥éªŒè¯å’Œä¼˜åŒ–
> - æ•…éšœæ’æŸ¥æ¡ˆä¾‹æ­£åœ¨æ”¶é›†å’Œè¡¥å……ä¸­
> - å¦‚æœ‰ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·æäº¤Issueåˆ°GitHubä»“åº“

> ç‰ˆæœ¬ï¼šv1.2.0 | æ›´æ–°æ—¥æœŸï¼š2025-09-03 | ä½œè€…ï¼šDAMENG_EXPORTER Team

## ç›®å½•
- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. å¿«é€Ÿå¼€å§‹](#2-å¿«é€Ÿå¼€å§‹)
- [3. é…ç½®è¯¦è§£](#3-é…ç½®è¯¦è§£)
- [4. æœ€ä½³å®è·µ](#4-æœ€ä½³å®è·µ)
- [5. è¿ç»´æŒ‡å—](#5-è¿ç»´æŒ‡å—)
- [6. æ•…éšœæ’æŸ¥](#6-æ•…éšœæ’æŸ¥)
- [7. é«˜çº§åŠŸèƒ½](#7-é«˜çº§åŠŸèƒ½)
- [8. ç›‘æ§é›†æˆ](#8-ç›‘æ§é›†æˆ)
- [9. å®‰å…¨åŠ å›º](#9-å®‰å…¨åŠ å›º)
- [é™„å½•Aï¼šå‘½ä»¤è¡Œå‚æ•°å®Œæ•´åˆ—è¡¨](#é™„å½•aå‘½ä»¤è¡Œå‚æ•°å®Œæ•´åˆ—è¡¨)
- [é™„å½•Bï¼šé…ç½®æ–‡ä»¶å‚æ•°å®Œæ•´åˆ—è¡¨](#é™„å½•bé…ç½®æ–‡ä»¶å‚æ•°å®Œæ•´åˆ—è¡¨)
- [é™„å½•Cï¼šç›‘æ§æŒ‡æ ‡è¯´æ˜](#é™„å½•cç›‘æ§æŒ‡æ ‡è¯´æ˜)
- [é™„å½•Dï¼šé”™è¯¯ä»£ç è¯´æ˜](#é™„å½•dé”™è¯¯ä»£ç è¯´æ˜)

---

## 1. æ¦‚è¿°

### 1.1 ç®€ä»‹
DAMENG_EXPORTER æ˜¯è¾¾æ¢¦æ•°æ®åº“çš„ Prometheus ç›‘æ§å¯¼å‡ºå™¨ï¼Œæ”¯æŒå¤šæ•°æ®æºç›‘æ§ã€å¯†ç åŠ å¯†ã€è‡ªå®šä¹‰æŒ‡æ ‡ç­‰åŠŸèƒ½ã€‚

### 1.2 ç‰ˆæœ¬å˜æ›´
**v1.2.0 é‡è¦å˜æ›´ï¼š**
- âš ï¸ **ç§»é™¤äº†å‘½ä»¤è¡Œå‚æ•°çš„é»˜è®¤å€¼**ï¼ˆä¹‹å‰é»˜è®¤ 127.0.0.1:5236/SYSDBA/SYSDBAï¼‰
- âœ… æ”¯æŒå¤šæ•°æ®æºç›‘æ§
- âœ… ä¼˜åŒ–äº†é…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°çš„ä¼˜å…ˆçº§é€»è¾‘
- âœ… å¢å¼ºäº†å¯†ç åŠ å¯†åŠŸèƒ½

### 1.3 æ ¸å¿ƒç‰¹æ€§
- æ”¯æŒå‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®æ–‡ä»¶ä¸¤ç§é…ç½®æ–¹å¼
- æ”¯æŒå¤šæ•°æ®æºå¹¶è¡Œç›‘æ§
- å†…ç½®å¯†ç åŠ å¯†åŠŸèƒ½
- æ”¯æŒè‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡
- æä¾›æ…¢SQLç›‘æ§
- æ”¯æŒ Basic Auth è®¤è¯
- çµæ´»çš„è¿æ¥æ± ç®¡ç†
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

---

## 2. å¿«é€Ÿå¼€å§‹

### 2.1 ä¸‹è½½å®‰è£…
```bash
# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
wget https://github.com/gaoyuan98/dameng_exporter/releases/download/v1.2.0/dameng_exporter_v1.2.0_linux_amd64.tar.gz

# è§£å‹
tar -xzvf dameng_exporter_v1.2.0_linux_amd64.tar.gz

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x dameng_exporter
```

### 2.2 ä¸‰ç§å¯åŠ¨æ–¹å¼

#### æ–¹å¼ä¸€ï¼šå‘½ä»¤è¡Œå‚æ•°ï¼ˆé€‚åˆæµ‹è¯•å’Œå•æ•°æ®æºï¼‰
```bash
# å¿…é¡»åŒæ—¶æŒ‡å®šä¸‰ä¸ªå‚æ•°
./dameng_exporter \
  --dbHost=192.168.1.100:5236 \
  --dbUser=SYSDBA \
  --dbPwd=SYSDBA123
```

#### æ–¹å¼äºŒï¼šé…ç½®æ–‡ä»¶ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
```bash
# 1. åˆ›å»ºé…ç½®æ–‡ä»¶ dameng_exporter.toml
# 2. æ‰§è¡Œ
./dameng_exporter
# æˆ–æŒ‡å®šé…ç½®æ–‡ä»¶
./dameng_exporter --configFile=/path/to/config.toml
```

#### æ–¹å¼ä¸‰ï¼šæ··åˆæ¨¡å¼ï¼ˆå‘½ä»¤è¡Œè¦†ç›–é…ç½®æ–‡ä»¶ï¼‰
```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œä½†è¦†ç›–æ•°æ®æº
./dameng_exporter \
  --configFile=base.toml \
  --dbHost=test.db:5236 \
  --dbUser=TEST \
  --dbPwd=test123
```

### 2.3 éªŒè¯è¿è¡Œ
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:9200/metrics | grep dm_up

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
./dameng_exporter --help | head -1

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/dameng_exporter.log
```

---

## 3. é…ç½®è¯¦è§£

### 3.1 é…ç½®ä¼˜å…ˆçº§è§„åˆ™

```
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š
1. å‘½ä»¤è¡Œå®Œæ•´å‚æ•°ï¼ˆ--dbHost + --dbUser + --dbPwdï¼‰
2. é…ç½®æ–‡ä»¶è®¾ç½®
3. ç¨‹åºå†…ç½®é»˜è®¤å€¼
```

**é‡è¦è§„åˆ™ï¼š**
- æ•°æ®åº“è¿æ¥å‚æ•°å¿…é¡»**åŒæ—¶æŒ‡å®š**æˆ–**éƒ½ä¸æŒ‡å®š**
- åªæŒ‡å®šéƒ¨åˆ†å‚æ•°ä¼šæŠ¥é”™é€€å‡º
- å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šåä¼š**å®Œå…¨æ›¿æ¢**é…ç½®æ–‡ä»¶çš„æ•°æ®æº

### 3.2 æœ€å°é…ç½®ç¤ºä¾‹

#### å‘½ä»¤è¡Œæœ€å°é…ç½®
```bash
./dameng_exporter \
  --dbHost=localhost:5236 \
  --dbUser=SYSDBA \
  --dbPwd=SYSDBA
```

#### é…ç½®æ–‡ä»¶æœ€å°é…ç½®
```toml
[[datasource]]
name = "default"
dbHost = "localhost:5236"
dbUser = "SYSDBA"
dbPwd = "SYSDBA"
```

### 3.3 å®Œæ•´é…ç½®ç¤ºä¾‹

```toml
# =====================================
# å…¨å±€é…ç½®
# =====================================
listenAddress = ":9200"              # ç›‘å¬åœ°å€å’Œç«¯å£
metricPath = "/metrics"               # æŒ‡æ ‡æš´éœ²è·¯å¾„
version = "v1.2.0"                    # ç‰ˆæœ¬ä¿¡æ¯ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰

# æ—¥å¿—é…ç½®
logLevel = "info"                     # æ—¥å¿—çº§åˆ«ï¼šdebug|info|warn|error
logMaxSize = 10                       # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆMBï¼‰
logMaxBackups = 3                     # æ—¥å¿—æ–‡ä»¶æœ€å¤§å¤‡ä»½æ•°
logMaxAge = 30                        # æ—¥å¿—æ–‡ä»¶æœ€å¤§ä¿ç•™å¤©æ•°

# å®‰å…¨é…ç½®
encodeConfigPwd = false               # å¯åŠ¨æ—¶æ˜¯å¦è‡ªåŠ¨åŠ å¯†æ˜æ–‡å¯†ç 
enableBasicAuth = false               # æ˜¯å¦å¯ç”¨HTTP Basicè®¤è¯
basicAuthUsername = ""                # Basicè®¤è¯ç”¨æˆ·å
basicAuthPassword = ""                # Basicè®¤è¯å¯†ç ï¼ˆæ”¯æŒENC()åŠ å¯†æ ¼å¼ï¼‰

# æ€§èƒ½é…ç½®
globalTimeoutSeconds = 5              # å…¨å±€é‡‡é›†è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
collectionMode = "blocking"          # é‡‡é›†æ¨¡å¼ï¼šblocking|fast
enableHealthPing = true              # æ˜¯å¦å¯ç”¨å‘¨æœŸæ€§å¥åº·æ£€æŸ¥ï¼ˆç¦ç”¨åä»…åœ¨æŸ¥è¯¢å¤±è´¥æ—¶ç¡®è®¤è¿æ¥çŠ¶æ€ï¼‰

# =====================================
# æ•°æ®æºé…ç½®ï¼ˆæ”¯æŒå¤šä¸ªï¼‰
# =====================================
[[datasource]]
# åŸºç¡€ä¿¡æ¯
name = "prod_master"                  # æ•°æ®æºå”¯ä¸€æ ‡è¯†ï¼ˆå¿…éœ€ï¼‰
description = "ç”Ÿäº§ç¯å¢ƒä¸»åº“"           # æ•°æ®æºæè¿°
enabled = true                        # æ˜¯å¦å¯ç”¨æ­¤æ•°æ®æº

# è¿æ¥é…ç½®
dbHost = "192.168.1.100:5236"        # æ•°æ®åº“åœ°å€:ç«¯å£ï¼ˆå¿…éœ€ï¼‰
dbUser = "SYSDBA"                     # æ•°æ®åº“ç”¨æˆ·åï¼ˆå¿…éœ€ï¼‰
dbPwd = "SYSDBA123"                   # æ•°æ®åº“å¯†ç ï¼ˆå¿…éœ€ï¼Œæ”¯æŒENC()åŠ å¯†ï¼‰

# è¿æ¥æ± é…ç½®
queryTimeout = 10                    # å•ä¸ªæŸ¥è¯¢è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
maxOpenConns = 10                     # æœ€å¤§æ‰“å¼€è¿æ¥æ•°
maxIdleConns = 2                      # æœ€å¤§ç©ºé—²è¿æ¥æ•°
connMaxLifetime = 30                  # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ†é’Ÿï¼‰

# ç¼“å­˜é…ç½®
bigKeyDataCacheTime = 60              # å¤§æ•°æ®æŸ¥è¯¢ç¼“å­˜æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
alarmKeyCacheTime = 5                 # å‘Šè­¦æ•°æ®ç¼“å­˜æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰

# æ…¢SQLç›‘æ§
checkSlowSQL = false                  # æ˜¯å¦æ£€æŸ¥æ…¢SQL
slowSqlTime = 10000                   # æ…¢SQLé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
slowSqlMaxRows = 10                   # è¿”å›æ…¢SQLæœ€å¤§è¡Œæ•°

# æŒ‡æ ‡æ³¨å†Œ
registerHostMetrics = false           # æ˜¯å¦æ³¨å†Œä¸»æœºæŒ‡æ ‡
registerDatabaseMetrics = true        # æ˜¯å¦æ³¨å†Œæ•°æ®åº“æŒ‡æ ‡
registerDmhsMetrics = false           # æ˜¯å¦æ³¨å†ŒDMHSæŒ‡æ ‡
registerCustomMetrics = true          # æ˜¯å¦æ³¨å†Œè‡ªå®šä¹‰æŒ‡æ ‡
customMetricsFile = "./custom_queries.metrics"  # è‡ªå®šä¹‰æŒ‡æ ‡æ–‡ä»¶è·¯å¾„

# å…¶ä»–é…ç½®
priority = 1                          # ä¼˜å…ˆçº§ï¼ˆç”¨äºè´Ÿè½½å‡è¡¡ï¼‰
labels = "env=prod,dc=beijing"       # Prometheusæ ‡ç­¾ï¼ˆkey=valueæ ¼å¼ï¼‰

# ç¬¬äºŒä¸ªæ•°æ®æºç¤ºä¾‹
[[datasource]]
name = "prod_slave"
enabled = true
dbHost = "192.168.1.101:5236"
dbUser = "SYSDBA"
dbPwd = "ENC(zsvHz8TN9c/S2sXY3s/Y7svHz8TNm5iZhA==)"  # åŠ å¯†å¯†ç 
queryTimeout = 10
registerDatabaseMetrics = true
labels = "env=prod,role=slave"
```

> ğŸ’¡ **é™ä½æ¢æ´»å‹åŠ›**ï¼šå°† `enableHealthPing` è®¾ä¸º `false` åï¼ŒExporter ä¸å†æŒ‰å›ºå®šé—´éš”å¯¹æ‰€æœ‰æ•°æ®æºæ‰§è¡Œ Pingï¼Œåªåœ¨é‡‡é›† SQL æŠ¥é”™æ—¶å¯¹è¯¥æ•°æ®æºè¡¥ä¸€æ¬¡ç¡®è®¤æ€§ Pingã€‚ç¡®è®¤å¤±è´¥ä¼šç«‹å³å°†å…¶é™çº§åˆ°å¤±è´¥æ± å¹¶äº¤ç”±è‡ªåŠ¨é‡è¯•æ¨¡å—å¤„ç†ï¼Œ`dmdb_up` æŒ‡æ ‡ä»èƒ½å³æ—¶åæ˜ çœŸå®çŠ¶æ€ã€‚

### 3.4 å¯†ç åŠ å¯†

#### ç”ŸæˆåŠ å¯†å¯†ç 
```bash
# åŠ å¯†å¯†ç 
./dameng_exporter --encryptPwd="YourPlainPassword"
# è¾“å‡ºï¼šEncrypted Password: ENC(zsvHz8TN9c/S2sXY3s/Y7svHz8TNm5iZhA==)

# åŠ å¯†Basic Authå¯†ç 
./dameng_exporter --encryptBasicAuthPwd="BasicAuthPassword"
```

#### ä½¿ç”¨åŠ å¯†å¯†ç 
```toml
# åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨
dbPwd = "ENC(zsvHz8TN9c/S2sXY3s/Y7svHz8TNm5iZhA==)"
basicAuthPassword = "ENC(xxxxx)"

# æˆ–åœ¨å‘½ä»¤è¡Œä½¿ç”¨
./dameng_exporter \
  --dbHost=192.168.1.100:5236 \
  --dbUser=SYSDBA \
  --dbPwd="ENC(zsvHz8TN9c/S2sXY3s/Y7svHz8TNm5iZhA==)"
```

---

## 4. æœ€ä½³å®è·µ

### 4.1 ç¯å¢ƒé…ç½®å»ºè®®

| ç¯å¢ƒ | é…ç½®æ–¹å¼ | æ—¥å¿—çº§åˆ« | è¿æ¥æ•° | ç¼“å­˜æ—¶é—´ | æ…¢SQLç›‘æ§ |
|------|---------|---------|--------|----------|-----------|
| å¼€å‘ | å‘½ä»¤è¡Œ | debug | 5 | 5åˆ†é’Ÿ | å…³é—­ |
| æµ‹è¯• | é…ç½®æ–‡ä»¶ | info | 10 | 30åˆ†é’Ÿ | å¼€å¯ |
| ç”Ÿäº§ | é…ç½®æ–‡ä»¶ | warn | 20 | 60åˆ†é’Ÿ | ä¸»åº“å¼€å¯ |

### 4.2 ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿

```toml
# production.toml
listenAddress = ":9200"
logLevel = "info"
logMaxSize = 100                      # ç”Ÿäº§ç¯å¢ƒåŠ å¤§æ—¥å¿—æ–‡ä»¶
logMaxBackups = 7                     # ä¿ç•™ä¸€å‘¨
encodeConfigPwd = true                # è‡ªåŠ¨åŠ å¯†
enableBasicAuth = true                # å¯ç”¨è®¤è¯
basicAuthUsername = "prometheus"
basicAuthPassword = "ENC(xxxxx)"

[[datasource]]
name = "prod_primary"
dbHost = "primary.db.company.com:5236"
dbUser = "MONITOR"                    # ä½¿ç”¨ä¸“ç”¨ç›‘æ§è´¦å·
dbPwd = "ENC(xxxxx)"
maxOpenConns = 20                     # ç”Ÿäº§ç¯å¢ƒå¢åŠ è¿æ¥æ•°
maxIdleConns = 5
queryTimeout = 10
bigKeyDataCacheTime = 60
checkSlowSQL = true                   # ä¸»åº“ç›‘æ§æ…¢SQL
slowSqlTime = 5000                    # 5ç§’ä¸ºæ…¢æŸ¥è¯¢
registerDatabaseMetrics = true
registerHostMetrics = true            # ä¸»åº“ç›‘æ§ä¸»æœº
labels = "env=prod,role=master,dc=beijing"

[[datasource]]
name = "prod_standby"
dbHost = "standby.db.company.com:5236"
dbUser = "MONITOR"
dbPwd = "ENC(xxxxx)"
maxOpenConns = 15
maxIdleConns = 3
queryTimeout = 10
bigKeyDataCacheTime = 120             # å¤‡åº“å»¶é•¿ç¼“å­˜
checkSlowSQL = false                  # å¤‡åº“ä¸ç›‘æ§æ…¢SQL
registerDatabaseMetrics = true
registerHostMetrics = false           # å¤‡åº“ä¸ç›‘æ§ä¸»æœº
labels = "env=prod,role=standby,dc=shanghai"
```

### 4.3 ç›‘æ§è´¦å·æƒé™é…ç½®

```sql
-- åˆ›å»ºç›‘æ§ä¸“ç”¨è´¦å·ï¼ˆæœ€å°æƒé™åŸåˆ™ï¼‰
CREATE USER MONITOR IDENTIFIED BY "Monitor@2025#Complex";

-- æˆäºˆå¿…è¦çš„ç³»ç»Ÿè§†å›¾æƒé™
GRANT SELECT ON V$INSTANCE TO MONITOR;
GRANT SELECT ON V$DATABASE TO MONITOR;
GRANT SELECT ON V$PARAMETER TO MONITOR;
GRANT SELECT ON V$DATAFILE TO MONITOR;
GRANT SELECT ON V$TABLESPACE TO MONITOR;
GRANT SELECT ON V$TEMPFILE TO MONITOR;
GRANT SELECT ON V$LOGFILE TO MONITOR;
GRANT SELECT ON V$ARCHIVED_LOG TO MONITOR;
GRANT SELECT ON V$SESSION TO MONITOR;
GRANT SELECT ON V$PROCESS TO MONITOR;
GRANT SELECT ON V$LOCK TO MONITOR;
GRANT SELECT ON V$TRANSACTION TO MONITOR;
GRANT SELECT ON V$SQL TO MONITOR;
GRANT SELECT ON V$SQLAREA TO MONITOR;
GRANT SELECT ON V$SQLTEXT TO MONITOR;
GRANT SELECT ON V$SYSTEM_EVENT TO MONITOR;
GRANT SELECT ON V$SESSION_EVENT TO MONITOR;
GRANT SELECT ON V$WAITSTAT TO MONITOR;
GRANT SELECT ON V$LATCH TO MONITOR;
GRANT SELECT ON V$SYSSTAT TO MONITOR;
GRANT SELECT ON V$SESSTAT TO MONITOR;
GRANT SELECT ON V$STATNAME TO MONITOR;
GRANT SELECT ON V$MEMORY_TARGET TO MONITOR;
GRANT SELECT ON V$SGA TO MONITOR;
GRANT SELECT ON V$SGAINFO TO MONITOR;
GRANT SELECT ON V$PGASTAT TO MONITOR;

-- å¦‚éœ€ç›‘æ§ç‰¹å®šä¸šåŠ¡è¡¨ï¼ˆå¯é€‰ï¼‰
GRANT SELECT ON SCHEMA_NAME.TABLE_NAME TO MONITOR;

-- å¦‚éœ€ç›‘æ§å¤‡ä»½ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
GRANT SELECT ON V$BACKUP TO MONITOR;
GRANT SELECT ON V$BACKUP_SET TO MONITOR;
```

### 4.4 å®¹å™¨åŒ–éƒ¨ç½²

#### Dockeréƒ¨ç½²
```dockerfile
# Dockerfile
FROM alpine:3.18
RUN apk add --no-cache ca-certificates tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone
COPY dameng_exporter /usr/local/bin/
RUN chmod +x /usr/local/bin/dameng_exporter
EXPOSE 9200
USER nobody
ENTRYPOINT ["/usr/local/bin/dameng_exporter"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  dameng-exporter:
    image: dameng_exporter:v1.2.0
    container_name: dameng-exporter
    restart: unless-stopped
    ports:
      - "9200:9200"
    volumes:
      - ./config:/etc/dameng_exporter:ro
      - ./logs:/var/log/dameng_exporter
    environment:
      - TZ=Asia/Shanghai
    command:
      - --configFile=/etc/dameng_exporter/dameng_exporter.toml
    networks:
      - monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9200/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  monitoring:
    external: true
```

#### Kuberneteséƒ¨ç½²
```yaml
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dameng-exporter-config
  namespace: monitoring
data:
  dameng_exporter.toml: |
    listenAddress = ":9200"
    logLevel = "info"
    enableBasicAuth = true
    basicAuthUsername = "prometheus"
    basicAuthPassword = "ENC(xxxxx)"
    
    [[datasource]]
    name = "k8s_dameng"
    dbHost = "dameng-service.database.svc.cluster.local:5236"
    dbUser = "MONITOR"
    dbPwd = "ENC(xxxxx)"
    registerDatabaseMetrics = true
---
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dameng-exporter
  namespace: monitoring
  labels:
    app: dameng-exporter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dameng-exporter
  template:
    metadata:
      labels:
        app: dameng-exporter
    spec:
      containers:
      - name: dameng-exporter
        image: dameng_exporter:v1.2.0
        imagePullPolicy: IfNotPresent
        ports:
        - name: metrics
          containerPort: 9200
          protocol: TCP
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /metrics
            port: metrics
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
        readinessProbe:
          httpGet:
            path: /metrics
            port: metrics
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
        volumeMounts:
        - name: config
          mountPath: /etc/dameng_exporter
          readOnly: true
        - name: logs
          mountPath: /var/log/dameng_exporter
        args:
        - --configFile=/etc/dameng_exporter/dameng_exporter.toml
      volumes:
      - name: config
        configMap:
          name: dameng-exporter-config
      - name: logs
        emptyDir: {}
---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: dameng-exporter
  namespace: monitoring
  labels:
    app: dameng-exporter
spec:
  type: ClusterIP
  ports:
  - name: metrics
    port: 9200
    targetPort: metrics
    protocol: TCP
  selector:
    app: dameng-exporter
```

### 4.5 Prometheusé›†æˆ

```yaml
# prometheus.yml
global:
  scrape_interval: 30s
  evaluation_interval: 30s
  external_labels:
    monitor: 'dameng-monitor'

scrape_configs:
  - job_name: 'dameng'
    scrape_interval: 30s
    scrape_timeout: 10s
    metrics_path: '/metrics'
    basic_auth:
      username: 'prometheus'
      password: 'your_password'
    static_configs:
      - targets:
        - 'dameng-exporter-prod:9200'
        - 'dameng-exporter-test:9200'
    relabel_configs:
      # ä»targetä¸­æå–instanceåç§°
      - source_labels: [__address__]
        target_label: __tmp_instance
        regex: '([^:]+)(?::\d+)?'
        replacement: '${1}'
      - source_labels: [__tmp_instance]
        target_label: instance
        regex: 'dameng-exporter-(.*)'
        replacement: '${1}'
```

### 4.6 å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# dameng_alerts.yml
groups:
  - name: dameng_database
    interval: 30s
    rules:
    # æ•°æ®åº“å®ä¾‹ä¸å¯ç”¨
    - alert: DamengInstanceDown
      expr: up{job="dameng"} == 0
      for: 1m
      labels:
        severity: critical
        component: database
      annotations:
        summary: "è¾¾æ¢¦æ•°æ®åº“å®ä¾‹ä¸å¯ç”¨"
        description: "å®ä¾‹ {{ $labels.instance }} å·²ç»è¶…è¿‡1åˆ†é’Ÿæ— æ³•è®¿é—®"
        
    # è¿æ¥æ•°è¿‡é«˜
    - alert: DamengHighConnections
      expr: dm_connections_active / dm_connections_max > 0.8
      for: 5m
      labels:
        severity: warning
        component: database
      annotations:
        summary: "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜"
        description: "å®ä¾‹ {{ $labels.instance }} è¿æ¥æ•°ä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œå½“å‰ï¼š{{ $value | humanizePercentage }}"
        
    # æ…¢æŸ¥è¯¢è¿‡å¤š
    - alert: DamengTooManySlowQueries
      expr: rate(dm_slow_queries_total[5m]) > 10
      for: 5m
      labels:
        severity: warning
        component: database
      annotations:
        summary: "æ…¢æŸ¥è¯¢è¿‡å¤š"
        description: "å®ä¾‹ {{ $labels.instance }} æ¯åˆ†é’Ÿæ…¢æŸ¥è¯¢è¶…è¿‡10ä¸ª"
        
    # è¡¨ç©ºé—´ä½¿ç”¨ç‡è¿‡é«˜
    - alert: DamengTablespaceUsageHigh
      expr: dm_tablespace_used_bytes / dm_tablespace_total_bytes > 0.9
      for: 10m
      labels:
        severity: warning
        component: database
      annotations:
        summary: "è¡¨ç©ºé—´ä½¿ç”¨ç‡è¿‡é«˜"
        description: "å®ä¾‹ {{ $labels.instance }} è¡¨ç©ºé—´ {{ $labels.tablespace }} ä½¿ç”¨ç‡è¶…è¿‡90%"
        
    # å½’æ¡£ç©ºé—´ä¸è¶³
    - alert: DamengArchiveSpaceLow
      expr: dm_archive_space_free_bytes < 10737418240  # 10GB
      for: 5m
      labels:
        severity: critical
        component: database
      annotations:
        summary: "å½’æ¡£ç©ºé—´ä¸è¶³"
        description: "å®ä¾‹ {{ $labels.instance }} å½’æ¡£ç©ºé—´å‰©ä½™ä¸è¶³10GB"
```

---

## 5. è¿ç»´æŒ‡å—

### 5.1 æ—¥å¸¸è¿ç»´

#### å¯åŠ¨ä¸åœæ­¢
```bash
# å‰å°è¿è¡Œï¼ˆè°ƒè¯•ï¼‰
./dameng_exporter --configFile=dameng_exporter.toml

# åå°è¿è¡Œ
nohup ./dameng_exporter --configFile=dameng_exporter.toml > /dev/null 2>&1 &

# æŸ¥çœ‹è¿›ç¨‹
ps -ef | grep dameng_exporter

# åœæ­¢æœåŠ¡
kill -TERM $(pidof dameng_exporter)
```

#### SystemdæœåŠ¡ç®¡ç†
```ini
# /etc/systemd/system/dameng_exporter.service
[Unit]
Description=Dameng Database Exporter
After=network.target

[Service]
Type=simple
User=prometheus
Group=prometheus
ExecStart=/usr/local/bin/dameng_exporter --configFile=/etc/dameng_exporter/dameng_exporter.toml
Restart=on-failure
RestartSec=5s
StandardOutput=journal
StandardError=journal
SyslogIdentifier=dameng_exporter

[Install]
WantedBy=multi-user.target
```

```bash
# é‡æ–°åŠ è½½systemdé…ç½®
systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
systemctl start dameng_exporter

# åœæ­¢æœåŠ¡
systemctl stop dameng_exporter

# é‡å¯æœåŠ¡
systemctl restart dameng_exporter

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status dameng_exporter

# è®¾ç½®å¼€æœºè‡ªå¯
systemctl enable dameng_exporter

# æŸ¥çœ‹æ—¥å¿—
journalctl -u dameng_exporter -f
```

### 5.2 æ—¥å¿—ç®¡ç†

```bash
# æ—¥å¿—ä½ç½®
logs/
â”œâ”€â”€ dameng_exporter.log          # å½“å‰æ—¥å¿—
â”œâ”€â”€ dameng_exporter-2025-09-02.log  # å½’æ¡£æ—¥å¿—
â””â”€â”€ dameng_exporter-2025-09-01.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR logs/dameng_exporter.log

# æŸ¥çœ‹è­¦å‘Šæ—¥å¿—
grep WARN logs/dameng_exporter.log

# å®æ—¶ç›‘æ§æ—¥å¿—
tail -f logs/dameng_exporter.log

# ç»Ÿè®¡é”™è¯¯æ•°é‡
grep -c ERROR logs/dameng_exporter.log

# æ¸…ç†æ—§æ—¥å¿—
find logs/ -name "*.log" -mtime +30 -delete
```

### 5.3 æ€§èƒ½è°ƒä¼˜

#### è¿æ¥æ± è°ƒä¼˜å‚è€ƒ

| åœºæ™¯ | maxOpenConns | maxIdleConns | connMaxLifetime | queryTimeout |
|------|--------------|--------------|-----------------|--------------|
| ä½è´Ÿè½½ï¼ˆ<100 QPSï¼‰ | 5 | 1 | 60åˆ†é’Ÿ | 30ç§’ |
| ä¸­è´Ÿè½½ï¼ˆ100-500 QPSï¼‰ | 15 | 3 | 30åˆ†é’Ÿ | 20ç§’ |
| é«˜è´Ÿè½½ï¼ˆ>500 QPSï¼‰ | 30 | 10 | 10åˆ†é’Ÿ | 10ç§’ |
| ç½‘ç»œä¸ç¨³å®š | 10 | 2 | 5åˆ†é’Ÿ | 15ç§’ |
| æ•°æ®ä»“åº“ | 10 | 2 | 30åˆ†é’Ÿ | 120ç§’ |

#### ç¼“å­˜ç­–ç•¥

```toml
# é™æ€æ•°æ®å¤šï¼Œå˜åŒ–å°‘
bigKeyDataCacheTime = 180    # 3å°æ—¶
alarmKeyCacheTime = 30       # 30åˆ†é’Ÿ

# å®æ—¶æ€§è¦æ±‚é«˜
bigKeyDataCacheTime = 5      # 5åˆ†é’Ÿ
alarmKeyCacheTime = 1        # 1åˆ†é’Ÿ

# å¹³è¡¡ç­–ç•¥ï¼ˆæ¨èï¼‰
bigKeyDataCacheTime = 60     # 1å°æ—¶
alarmKeyCacheTime = 5        # 5åˆ†é’Ÿ
```

### 5.4 ç›‘æ§æŒ‡æ ‡è¯´æ˜

ä¸»è¦æŒ‡æ ‡ç±»å‹ï¼š
- `dm_up`: æ•°æ®åº“æ˜¯å¦å¯ç”¨ï¼ˆ1=å¯ç”¨ï¼Œ0=ä¸å¯ç”¨ï¼‰
- `dm_connections_*`: è¿æ¥ç›¸å…³æŒ‡æ ‡
- `dm_sessions_*`: ä¼šè¯ç›¸å…³æŒ‡æ ‡
- `dm_transactions_*`: äº‹åŠ¡ç›¸å…³æŒ‡æ ‡
- `dm_tablespace_*`: è¡¨ç©ºé—´ç›¸å…³æŒ‡æ ‡
- `dm_slow_queries_*`: æ…¢æŸ¥è¯¢ç›¸å…³æŒ‡æ ‡

---

## 6. æ•…éšœæ’æŸ¥

### 6.1 å¸¸è§é—®é¢˜

#### é—®é¢˜1ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
```
ERROR: Failed to create pool for datasource: Error -2501: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
```
**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥æ•°æ®åº“åœ°å€å’Œç«¯å£æ˜¯å¦æ­£ç¡®
2. éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
3. ç¡®è®¤æ•°æ®åº“æœåŠ¡æ­£å¸¸è¿è¡Œ
4. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™

#### é—®é¢˜2ï¼šå‚æ•°ä¸å®Œæ•´é”™è¯¯
```
é”™è¯¯ï¼šæ•°æ®åº“è¿æ¥å‚æ•°ä¸å®Œæ•´ï¼
å¿…é¡»åŒæ—¶æŒ‡å®šï¼š--dbHostã€--dbUserã€--dbPwd
```
**è§£å†³æ–¹æ³•ï¼š**
å¿…é¡»åŒæ—¶æŒ‡å®šæ‰€æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œæˆ–è€…éƒ½ä¸æŒ‡å®šï¼ˆä½¿ç”¨é…ç½®æ–‡ä»¶ï¼‰

#### é—®é¢˜3ï¼šé…ç½®æ–‡ä»¶è§£æå¤±è´¥
```
Error loading TOML config file: failed to parse config file as TOML
```
**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥TOMLè¯­æ³•æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å¼•å·ã€æ‹¬å·åŒ¹é…
3. ä½¿ç”¨åœ¨çº¿TOMLéªŒè¯å·¥å…·æ£€æŸ¥

#### é—®é¢˜4ï¼šç«¯å£è¢«å ç”¨
```
bind: address already in use
```
**è§£å†³æ–¹æ³•ï¼š**
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep 9200
# æˆ–
lsof -i:9200

# ä¿®æ”¹é…ç½®ä½¿ç”¨å…¶ä»–ç«¯å£
listenAddress = ":9201"
```

### 6.2 è°ƒè¯•æŠ€å·§

```bash
# å¼€å¯è°ƒè¯•æ—¥å¿—
./dameng_exporter --logLevel=debug

# æµ‹è¯•æ•°æ®åº“è¿æ¥
./dameng_exporter \
  --dbHost=test.db:5236 \
  --dbUser=TEST \
  --dbPwd=test \
  --logLevel=debug \
  --queryTimeout=10

# éªŒè¯é…ç½®æ–‡ä»¶
./dameng_exporter --configFile=test.toml --logLevel=debug

# æ£€æŸ¥æŒ‡æ ‡è¾“å‡º
curl -s http://localhost:9200/metrics | grep -E "^dm_"
```

### 6.3 æ€§èƒ½é—®é¢˜æ’æŸ¥

```bash
# 1. æ£€æŸ¥è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
curl -s http://localhost:9200/metrics | grep dm_connections

# 2. æŸ¥çœ‹æ…¢æŸ¥è¯¢
grep "slow query" logs/dameng_exporter.log

# 3. ç›‘æ§å†…å­˜ä½¿ç”¨
ps aux | grep dameng_exporter

# 4. æŸ¥çœ‹goroutineæ•°é‡
curl http://localhost:9200/debug/pprof/goroutine?debug=1

# 5. CPUåˆ†æ
go tool pprof http://localhost:9200/debug/pprof/profile
```

---

## é™„å½•Aï¼šå‘½ä»¤è¡Œå‚æ•°å®Œæ•´åˆ—è¡¨

### æ•°æ®åº“è¿æ¥å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | å¿…éœ€ | è¯´æ˜ |
|------|------|--------|------|------|
| --dbHost | string | æ—  | ä¸dbUserã€dbPwdä¸€èµ·å¿…éœ€ | æ•°æ®åº“åœ°å€å’Œç«¯å£ï¼Œæ ¼å¼ï¼šhost:port |
| --dbUser | string | æ—  | ä¸dbHostã€dbPwdä¸€èµ·å¿…éœ€ | æ•°æ®åº“ç”¨æˆ·å |
| --dbPwd | string | æ—  | ä¸dbHostã€dbUserä¸€èµ·å¿…éœ€ | æ•°æ®åº“å¯†ç ï¼Œæ”¯æŒæ˜æ–‡å’ŒENC()åŠ å¯†æ ¼å¼ |
| --dbName | string | cmdline_<host> | å¦ | æ•°æ®æºåç§°ï¼ŒæœªæŒ‡å®šæ—¶è‡ªåŠ¨ç”Ÿæˆ |

### æœåŠ¡é…ç½®å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| --configFile | string | ./dameng_exporter.toml | é…ç½®æ–‡ä»¶è·¯å¾„ |
| --listenAddress | string | :9200 | æœåŠ¡ç›‘å¬åœ°å€ |
| --metricPath | string | /metrics | æŒ‡æ ‡æš´éœ²è·¯å¾„ |

### è¿æ¥æ± å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|-----|------|
| --queryTimeout | int | 10  | æŸ¥è¯¢è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| --maxOpenConns | int | 10  | æœ€å¤§æ‰“å¼€è¿æ¥æ•° |
| --maxIdleConns | int | 2   | æœ€å¤§ç©ºé—²è¿æ¥æ•° |
| --connMaxLifetime | int | 30  | è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ†é’Ÿï¼‰ |

### æ—¥å¿—å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| --logLevel | string | info | æ—¥å¿—çº§åˆ«ï¼šdebugã€infoã€warnã€error |
| --logMaxSize | int | 10 | å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆMBï¼‰ |
| --logMaxBackups | int | 3 | æ—¥å¿—æ–‡ä»¶æœ€å¤§å¤‡ä»½æ•° |
| --logMaxAge | int | 30 | æ—¥å¿—æ–‡ä»¶æœ€å¤§ä¿ç•™å¤©æ•° |

### åŠŸèƒ½å¼€å…³å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| --registerDatabaseMetrics | bool | true | æ˜¯å¦æ³¨å†Œæ•°æ®åº“æŒ‡æ ‡ |
| --registerHostMetrics | bool | false | æ˜¯å¦æ³¨å†Œä¸»æœºæŒ‡æ ‡ |
| --registerDmhsMetrics | bool | false | æ˜¯å¦æ³¨å†ŒDMHSæŒ‡æ ‡ |
| --registerCustomMetrics | bool | true | æ˜¯å¦æ³¨å†Œè‡ªå®šä¹‰æŒ‡æ ‡ |
| --checkSlowSql | bool | false | æ˜¯å¦æ£€æŸ¥æ…¢SQL |
| --slowSqlTime | int | 10000 | æ…¢SQLé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ |
| --slowSqlLimitRows | int | 10 | è¿”å›æ…¢SQLæœ€å¤§è¡Œæ•° |

### ç¼“å­˜å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| --bigKeyDataCacheTime | int | 60 | å¤§æ•°æ®æŸ¥è¯¢ç¼“å­˜æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ |
| --alarmKeyCacheTime | int | 5 | å‘Šè­¦æ•°æ®ç¼“å­˜æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ |

### å®‰å…¨å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| --encodeConfigPwd | bool | false | å¯åŠ¨æ—¶æ˜¯å¦è‡ªåŠ¨åŠ å¯†é…ç½®æ–‡ä»¶ä¸­çš„æ˜æ–‡å¯†ç  |
| --enableBasicAuth | bool | false | æ˜¯å¦å¯ç”¨HTTP Basicè®¤è¯ |
| --basicAuthUsername | string | ç©º | Basicè®¤è¯ç”¨æˆ·å |
| --basicAuthPassword | string | ç©º | Basicè®¤è¯å¯†ç  |
| --encryptPwd | string | ç©º | åŠ å¯†æŒ‡å®šå¯†ç å¹¶é€€å‡º |
| --encryptBasicAuthPwd | string | ç©º | åŠ å¯†Basic Authå¯†ç å¹¶é€€å‡º |

### æ€§èƒ½å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| --globalTimeoutSeconds | int | 5 | å…¨å±€é‡‡é›†è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| --collectionMode | string | blocking | é‡‡é›†æ¨¡å¼ï¼šblockingï¼ˆé˜»å¡ï¼‰ã€fastï¼ˆå¿«é€Ÿï¼‰ |
| --enableHealthPing | bool | true | æ˜¯å¦å¯ç”¨å‘¨æœŸæ€§å¥åº·æ£€æŸ¥ï¼Œfalse æ—¶ä»…åœ¨ SQL æŠ¥é”™æ—¶è¡¥å……æ¢æ´» |

---

## é™„å½•Bï¼šé…ç½®æ–‡ä»¶å‚æ•°å®Œæ•´åˆ—è¡¨

### å…¨å±€é…ç½®å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | å¿…éœ€ | è¯´æ˜ |
|------|------|--------|------|------|
| listenAddress | string | :9200 | å¦ | æœåŠ¡ç›‘å¬åœ°å€ |
| metricPath | string | /metrics | å¦ | æŒ‡æ ‡æš´éœ²è·¯å¾„ |
| version | string | è‡ªåŠ¨å¡«å…… | å¦ | ç‰ˆæœ¬ä¿¡æ¯ |
| logLevel | string | info | å¦ | æ—¥å¿—çº§åˆ« |
| logMaxSize | int | 10 | å¦ | æ—¥å¿—æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰ |
| logMaxBackups | int | 3 | å¦ | æ—¥å¿—å¤‡ä»½æ•° |
| logMaxAge | int | 30 | å¦ | æ—¥å¿—ä¿ç•™å¤©æ•° |
| encodeConfigPwd | bool | false | å¦ | è‡ªåŠ¨åŠ å¯†å¯†ç  |
| enableBasicAuth | bool | false | å¦ | å¯ç”¨Basicè®¤è¯ |
| basicAuthUsername | string | ç©º | å¦ | è®¤è¯ç”¨æˆ·å |
| basicAuthPassword | string | ç©º | å¦ | è®¤è¯å¯†ç  |
| globalTimeoutSeconds | int | 5 | å¦ | å…¨å±€è¶…æ—¶ï¼ˆç§’ï¼‰ |
| collectionMode | string | blocking | å¦ | é‡‡é›†æ¨¡å¼ |
| enableHealthPing | bool | true | å¦ | æ˜¯å¦å¯ç”¨å‘¨æœŸæ€§å¥åº·æ£€æŸ¥ï¼ˆç¦ç”¨åä»…åœ¨SQLé”™è¯¯æ—¶ç¡®è®¤ï¼‰ |

### æ•°æ®æºé…ç½®å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼                      | å¿…éœ€ | è¯´æ˜ |
|------|------|--------------------------|------|------|
| name | string | æ—                         | æ˜¯ | æ•°æ®æºå”¯ä¸€æ ‡è¯† |
| description | string | ç©º                        | å¦ | æ•°æ®æºæè¿° |
| enabled | bool | true                     | å¦ | æ˜¯å¦å¯ç”¨ |
| dbHost | string | æ—                         | æ˜¯ | æ•°æ®åº“åœ°å€:ç«¯å£ |
| dbUser | string | æ—                         | æ˜¯ | æ•°æ®åº“ç”¨æˆ·å |
| dbPwd | string | æ—                         | æ˜¯ | æ•°æ®åº“å¯†ç  |
| queryTimeout | int | 10                       | å¦ | æŸ¥è¯¢è¶…æ—¶ï¼ˆç§’ï¼‰ |
| maxOpenConns | int | 10                       | å¦ | æœ€å¤§è¿æ¥æ•° |
| maxIdleConns | int | 2                        | å¦ | æœ€å¤§ç©ºé—²è¿æ¥ |
| connMaxLifetime | int | 30                       | å¦ | è¿æ¥ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ†é’Ÿï¼‰ |
| bigKeyDataCacheTime | int | 60                       | å¦ | å¤§æ•°æ®ç¼“å­˜ï¼ˆåˆ†é’Ÿï¼‰ |
| alarmKeyCacheTime | int | 5                        | å¦ | å‘Šè­¦ç¼“å­˜ï¼ˆåˆ†é’Ÿï¼‰ |
| checkSlowSQL | bool | false                    | å¦ | æ£€æŸ¥æ…¢SQL |
| slowSqlTime | int | 10000                    | å¦ | æ…¢SQLé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ |
| slowSqlMaxRows | int | 10                       | å¦ | æ…¢SQLè¿”å›è¡Œæ•° |
| registerHostMetrics | bool | false                    | å¦ | æ³¨å†Œä¸»æœºæŒ‡æ ‡ |
| registerDatabaseMetrics | bool | true                     | å¦ | æ³¨å†Œæ•°æ®åº“æŒ‡æ ‡ |
| registerDmhsMetrics | bool | false                    | å¦ | æ³¨å†ŒDMHSæŒ‡æ ‡ |
| registerCustomMetrics | bool | true                     | å¦ | æ³¨å†Œè‡ªå®šä¹‰æŒ‡æ ‡ |
| customMetricsFile | string | ./custom_queries.metrics | å¦ | è‡ªå®šä¹‰æŒ‡æ ‡æ–‡ä»¶ |
| priority | int | 0                        | å¦ | ä¼˜å…ˆçº§ |
| labels | string | ç©º                        | å¦ | Prometheusæ ‡ç­¾ |

---

## é™„å½•Cï¼šç›‘æ§æŒ‡æ ‡è¯´æ˜

### åŸºç¡€æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| dm_up | Gauge | æ•°æ®åº“æ˜¯å¦å¯ç”¨ï¼ˆ1=å¯ç”¨ï¼Œ0=ä¸å¯ç”¨ï¼‰ | datasource |
| dm_uptime_seconds | Counter | æ•°æ®åº“è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰ | datasource |
| dm_version_info | Gauge | æ•°æ®åº“ç‰ˆæœ¬ä¿¡æ¯ | datasource, version |

### è¿æ¥æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| dm_connections_max | Gauge | æœ€å¤§å…è®¸è¿æ¥æ•° | datasource |
| dm_connections_active | Gauge | å½“å‰æ´»åŠ¨è¿æ¥æ•° | datasource |
| dm_connections_idle | Gauge | å½“å‰ç©ºé—²è¿æ¥æ•° | datasource |
| dm_connections_total | Counter | æ€»è¿æ¥æ•° | datasource |
| dm_connections_failed_total | Counter | å¤±è´¥çš„è¿æ¥æ•° | datasource |

### ä¼šè¯æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| dm_sessions_active | Gauge | æ´»åŠ¨ä¼šè¯æ•° | datasource |
| dm_sessions_inactive | Gauge | éæ´»åŠ¨ä¼šè¯æ•° | datasource |
| dm_sessions_blocked | Gauge | é˜»å¡çš„ä¼šè¯æ•° | datasource |
| dm_sessions_killed_total | Counter | è¢«ç»ˆæ­¢çš„ä¼šè¯æ€»æ•° | datasource |

### äº‹åŠ¡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| dm_transactions_total | Counter | äº‹åŠ¡æ€»æ•° | datasource |
| dm_transactions_commit_total | Counter | æäº¤çš„äº‹åŠ¡æ•° | datasource |
| dm_transactions_rollback_total | Counter | å›æ»šçš„äº‹åŠ¡æ•° | datasource |
| dm_transactions_active | Gauge | å½“å‰æ´»åŠ¨äº‹åŠ¡æ•° | datasource |

### è¡¨ç©ºé—´æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| dm_tablespace_total_bytes | Gauge | è¡¨ç©ºé—´æ€»å¤§å° | datasource, tablespace |
| dm_tablespace_used_bytes | Gauge | è¡¨ç©ºé—´å·²ç”¨å¤§å° | datasource, tablespace |
| dm_tablespace_free_bytes | Gauge | è¡¨ç©ºé—´å‰©ä½™å¤§å° | datasource, tablespace |
| dm_tablespace_usage_percent | Gauge | è¡¨ç©ºé—´ä½¿ç”¨ç‡ | datasource, tablespace |

### æ…¢æŸ¥è¯¢æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| dm_slow_queries_total | Counter | æ…¢æŸ¥è¯¢æ€»æ•° | datasource |
| dm_slow_query_duration_seconds | Histogram | æ…¢æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ | datasource |
| dm_slow_query_rows_examined | Histogram | æ…¢æŸ¥è¯¢æ‰«æè¡Œæ•°åˆ†å¸ƒ | datasource |

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| dm_buffer_cache_hit_ratio | Gauge | ç¼“å†²åŒºå‘½ä¸­ç‡ | datasource |
| dm_library_cache_hit_ratio | Gauge | åº“ç¼“å­˜å‘½ä¸­ç‡ | datasource |
| dm_disk_reads_total | Counter | ç£ç›˜è¯»å–æ€»æ•° | datasource |
| dm_disk_writes_total | Counter | ç£ç›˜å†™å…¥æ€»æ•° | datasource |

### é”æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| dm_locks_total | Gauge | å½“å‰é”æ€»æ•° | datasource |
| dm_locks_waiting | Gauge | ç­‰å¾…é”çš„æ•°é‡ | datasource |
| dm_deadlocks_total | Counter | æ­»é”æ€»æ•° | datasource |

### Counter ç±»å‹æŒ‡æ ‡å¤„ç†ç­–ç•¥

#### æ¦‚è¿°
Counter ç±»å‹æ˜¯ Prometheus ä¸­çš„ç´¯ç§¯è®¡æ•°å™¨ï¼Œåªä¼šé€’å¢ä¸ä¼šé€’å‡ï¼ˆé™¤éé‡å¯ï¼‰ã€‚å¯¹äºè¿™ç±»æŒ‡æ ‡ï¼Œæˆ‘ä»¬é‡‡ç”¨ç»Ÿä¸€çš„å¤„ç†ç­–ç•¥æ¥è®¡ç®—æ¯åˆ†é’Ÿçš„é€Ÿç‡å€¼ã€‚

#### æ ‡å‡†æŸ¥è¯¢æ¨¡å¼
```promql
rate(metric_name{filters}[$interval]) * 60
```

#### å®é™…ç¤ºä¾‹
```promql
# SQLè¯­å¥æ‰§è¡Œç»Ÿè®¡
rate(dmdbms_statement_type_total{
  statement_name="select statements",
  datasource=~"${datasource}",
  env=~"${env:.*}",
  region=~"${region:.*}",
  cluster=~"${cluster:.*}"
}[$interval]) * 60

# æ£€æŸ¥ç‚¹æ—¶é—´ç»Ÿè®¡
rate(dmdbms_ckpttime_total{
  datasource=~"${datasource}",
  env=~"${env:.*}",
  region=~"${region:.*}",
  cluster=~"${cluster:.*}"
}[$interval]) * 60
```

#### å…³é”®è¦ç´ è¯´æ˜

1. **rate() å‡½æ•°**
   - è‡ªåŠ¨è®¡ç®—æŒ‡å®šæ—¶é—´çª—å£å†…çš„æ¯ç§’å¢é•¿ç‡
   - è‡ªåŠ¨å¤„ç† Counter é‡ç½®ï¼ˆå¦‚æœåŠ¡é‡å¯ï¼‰
   - æä¾›å¹³æ»‘çš„é€Ÿç‡è®¡ç®—ï¼Œé¿å…ç¬æ—¶å°–å³°

2. **$interval å˜é‡**
   - ç”¨æˆ·å¯é€‰æ‹©çš„æ—¶é—´é—´éš”ï¼ˆ1m, 10m, 30m, 1hç­‰ï¼‰
   - å†³å®šè®¡ç®—é€Ÿç‡çš„æ—¶é—´çª—å£å¤§å°
   - å½±å“æ•°æ®çš„èšåˆç²’åº¦å’Œå¹³æ»‘ç¨‹åº¦

3. **ä¹˜ä»¥ 60**
   - å°†æ¯ç§’é€Ÿç‡è½¬æ¢ä¸ºæ¯åˆ†é’Ÿé€Ÿç‡
   - æ›´ç¬¦åˆä¸šåŠ¡ç†è§£ï¼ˆå¦‚ï¼šæ¯åˆ†é’Ÿæ‰§è¡Œæ¬¡æ•°ï¼‰
   - ç»Ÿä¸€æ‰€æœ‰é€Ÿç‡æŒ‡æ ‡çš„å•ä½

#### æ—¶é—´é—´éš”çš„å«ä¹‰

| é—´éš”é€‰æ‹© | è®¡ç®—çª—å£ | æ•ˆæœè¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|---------|
| 1m | 1åˆ†é’Ÿ | æ˜¾ç¤ºç»†ç²’åº¦å˜åŒ–ï¼Œæ³¢åŠ¨è¾ƒå¤§ | æ•…éšœæ’æŸ¥ã€å®æ—¶ç›‘æ§ |
| 10m | 10åˆ†é’Ÿ | ä¸­ç­‰å¹³æ»‘ï¼Œæ˜¾ç¤ºä¸­æœŸè¶‹åŠ¿ | æ—¥å¸¸ç›‘æ§ã€è¶‹åŠ¿åˆ†æ |
| 30m | 30åˆ†é’Ÿ | è¾ƒé«˜å¹³æ»‘ï¼Œè¿‡æ»¤çŸ­æœŸæ³¢åŠ¨ | ä¸šåŠ¡åˆ†æã€æŠ¥è¡¨ç»Ÿè®¡ |
| 1h | 1å°æ—¶ | é«˜åº¦å¹³æ»‘ï¼Œæ˜¾ç¤ºé•¿æœŸè¶‹åŠ¿ | å®¹é‡è§„åˆ’ã€å†å²å¯¹æ¯” |

#### åº”ç”¨çš„ Counter æŒ‡æ ‡åˆ—è¡¨

1. **SQLæ‰§è¡Œç»Ÿè®¡ç±»**
   - dmdbms_statement_type_totalï¼ˆå„ç±»SQLè¯­å¥æ‰§è¡Œæ¬¡æ•°ï¼‰
   - åŒ…æ‹¬ï¼šselect, insert, update, delete, ddl statements
   - parse count, hard parse count, plan total count
   - plan cache hit count, logic read count
   - physical read count, physical write count
   - transaction total count

2. **ç¼“å­˜ç»Ÿè®¡ç±»**
   - dmdbms_dict_cache_totalï¼ˆå­—å…¸ç¼“å­˜ç»Ÿè®¡ï¼‰
   - åŒ…æ‹¬ï¼šLRUæ·˜æ±°æ¬¡æ•°ã€DDLæ·˜æ±°æ¬¡æ•°

3. **ç³»ç»Ÿç»Ÿè®¡ç±»**
   - dmdbms_ckpttime_totalï¼ˆæ£€æŸ¥ç‚¹æ—¶é—´ç»Ÿè®¡ï¼‰
   - å…¶ä»–ç´¯ç§¯å‹ç³»ç»ŸæŒ‡æ ‡

#### ä¼˜åŠ¿è¯´æ˜

1. **è‡ªé€‚åº”æ€§**ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´é—´éš”åŠ¨æ€è°ƒæ•´
2. **å‡†ç¡®æ€§**ï¼šè‡ªåŠ¨å¤„ç†æœåŠ¡é‡å¯ç­‰å¼‚å¸¸æƒ…å†µ
3. **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰ Counter ç±»å‹æŒ‡æ ‡é‡‡ç”¨ç»Ÿä¸€å¤„ç†æ–¹å¼
4. **å¯è¯»æ€§**ï¼šæ¯åˆ†é’Ÿé€Ÿç‡æ¯”æ¯ç§’é€Ÿç‡æ›´ç›´è§‚

#### æ³¨æ„äº‹é¡¹

- å½“é‡‡é›†é—´éš”ä¸æŸ¥è¯¢é—´éš”ç›¸åŒæ—¶ï¼ˆå¦‚éƒ½æ˜¯1åˆ†é’Ÿï¼‰ï¼Œå¯èƒ½å‡ºç°æ•°æ®ç‚¹ä¸è¶³
- å»ºè®® Prometheus é‡‡é›†é—´éš”è®¾ç½®ä¸º30ç§’æˆ–æ›´çŸ­
- å¯¹äºå…³é”®æŒ‡æ ‡ï¼Œå¯è€ƒè™‘è®¾ç½®æœ€å°æ—¶é—´é—´éš”ä¸º2åˆ†é’Ÿ

---

## 7. é«˜çº§åŠŸèƒ½

### 7.1 è‡ªå®šä¹‰æŒ‡æ ‡é…ç½®

#### åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡æ–‡ä»¶
```yaml
# custom_queries.metrics ç¤ºä¾‹
metrics:
  # ä¸šåŠ¡è¡¨è¡Œæ•°ç›‘æ§
  - metric_name: business_table_rows
    type: gauge
    help: "ä¸šåŠ¡è¡¨è®°å½•æ•°ç»Ÿè®¡"
    key_labels:
      - table_name
    values: [row_count]
    query: |
      SELECT 
        TABLE_NAME as table_name,
        NUM_ROWS as row_count
      FROM DBA_TABLES
      WHERE OWNER = 'BUSINESS_SCHEMA'
    
  # è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡
  - metric_name: custom_performance_metric
    type: counter
    help: "è‡ªå®šä¹‰æ€§èƒ½è®¡æ•°å™¨"
    values: [value]
    query: |
      SELECT COUNT(*) as value 
      FROM V$SESSION 
      WHERE STATUS = 'ACTIVE'
      
  # å¤æ‚ä¸šåŠ¡æŒ‡æ ‡
  - metric_name: business_transaction_stats
    type: histogram
    help: "ä¸šåŠ¡äº‹åŠ¡ç»Ÿè®¡"
    key_labels:
      - transaction_type
      - status
    value_label: duration
    values: [count, sum]
    query: |
      SELECT 
        TRANSACTION_TYPE as transaction_type,
        STATUS as status,
        COUNT(*) as count,
        SUM(DURATION_MS) as sum
      FROM BUSINESS_TRANSACTIONS
      WHERE CREATED_TIME > SYSDATE - 1/24
      GROUP BY TRANSACTION_TYPE, STATUS
```

#### è‡ªå®šä¹‰æŒ‡æ ‡ç±»å‹è¯´æ˜

| æŒ‡æ ‡ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|---------|------|----------|
| gauge | å¯å¢å¯å‡çš„åº¦é‡å€¼ | å½“å‰å€¼ç»Ÿè®¡ï¼ˆå¦‚ï¼šè¡¨å¤§å°ã€è¿æ¥æ•°ï¼‰ |
| counter | åªå¢ä¸å‡çš„ç´¯è®¡å€¼ | ç´¯è®¡ç»Ÿè®¡ï¼ˆå¦‚ï¼šäº‹åŠ¡æ€»æ•°ã€é”™è¯¯æ¬¡æ•°ï¼‰ |
| histogram | åˆ†å¸ƒç»Ÿè®¡ | å»¶è¿Ÿã€å“åº”æ—¶é—´ç­‰åˆ†å¸ƒæƒ…å†µ |
| summary | åˆ†ä½æ•°ç»Ÿè®¡ | ç™¾åˆ†ä½æ€§èƒ½æŒ‡æ ‡ |

### 7.2 å¤šæ•°æ®æºè´Ÿè½½å‡è¡¡

#### é…ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥
```toml
# è´Ÿè½½å‡è¡¡é…ç½®
[[datasource]]
name = "primary_1"
priority = 10        # é«˜ä¼˜å…ˆçº§
weight = 3          # æƒé‡é…ç½®
maxConnections = 20

[[datasource]]
name = "primary_2"
priority = 10
weight = 2
maxConnections = 15

[[datasource]]
name = "standby_1"
priority = 5         # ä½ä¼˜å…ˆçº§ï¼ˆå¤‡ç”¨ï¼‰
weight = 1
maxConnections = 10
```

#### æ•…éšœè½¬ç§»é…ç½®
```toml
# å…¨å±€æ•…éšœè½¬ç§»è®¾ç½®
failoverEnabled = true
failoverRetryInterval = 30     # é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
failoverMaxRetries = 3         # æœ€å¤§é‡è¯•æ¬¡æ•°
healthCheckInterval = 60       # å¥åº·æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
```

### 7.3 æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### é‡‡é›†ä¼˜åŒ–
```toml
# åˆ†çº§é‡‡é›†ç­–ç•¥
[[datasource]]
name = "optimized_ds"

# é«˜é¢‘æŒ‡æ ‡ï¼ˆ30ç§’é‡‡é›†ä¸€æ¬¡ï¼‰
highFrequencyMetrics = [
  "dm_connections_active",
  "dm_transactions_active",
  "dm_sessions_active"
]

# ä¸­é¢‘æŒ‡æ ‡ï¼ˆ5åˆ†é’Ÿé‡‡é›†ä¸€æ¬¡ï¼‰
mediumFrequencyMetrics = [
  "dm_tablespace_usage",
  "dm_buffer_cache_hit_ratio"
]

# ä½é¢‘æŒ‡æ ‡ï¼ˆ30åˆ†é’Ÿé‡‡é›†ä¸€æ¬¡ï¼‰
lowFrequencyMetrics = [
  "dm_database_size",
  "dm_backup_status"
]
```

#### æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
1. **ä½¿ç”¨ç¼“å­˜**: å¯¹äºé™æ€æˆ–æ…¢å˜åŒ–æ•°æ®å¯ç”¨ç¼“å­˜
2. **å¹¶è¡Œé‡‡é›†**: å¯ç”¨`collectionMode = "fast"`å®ç°å¹¶è¡Œé‡‡é›†
3. **ç´¢å¼•ä¼˜åŒ–**: ç¡®ä¿ç›‘æ§æŸ¥è¯¢ç›¸å…³çš„ç³»ç»Ÿè§†å›¾æœ‰é€‚å½“ç´¢å¼•
4. **è¿æ¥å¤ç”¨**: åˆç†é…ç½®è¿æ¥æ± å‚æ•°

### 7.4 æ’ä»¶æ‰©å±•æœºåˆ¶

#### å¼€å‘è‡ªå®šä¹‰é‡‡é›†å™¨
```go
// custom_collector.go ç¤ºä¾‹
type CustomCollector struct {
    datasource *Datasource
}

func (c *CustomCollector) Describe(ch chan<- *prometheus.Desc) {
    // æè¿°æŒ‡æ ‡
}

func (c *CustomCollector) Collect(ch chan<- prometheus.Metric) {
    // é‡‡é›†é€»è¾‘
    query := "SELECT custom_metric FROM custom_table"
    // æ‰§è¡ŒæŸ¥è¯¢å¹¶æ¨é€æŒ‡æ ‡
}
```

#### æ³¨å†Œè‡ªå®šä¹‰é‡‡é›†å™¨
```toml
# é…ç½®æ–‡ä»¶ä¸­å¯ç”¨
[[datasource]]
name = "custom_enabled"
enableCustomCollector = true
customCollectorPath = "./plugins/custom_collector.so"
```

---

## 8. ç›‘æ§é›†æˆ

### 8.1 Grafanaé¢æ¿å¯¼å…¥ä¸é…ç½®

#### å¯¼å…¥é¢„ç½®é¢æ¿
1. ä¸‹è½½é¢æ¿æ–‡ä»¶ï¼š
   - `è¾¾æ¢¦DBç›‘æ§é¢æ¿_20250518.json` - ä¸»ç›‘æ§é¢æ¿
   - `DMå…¨å±€å‘Šè­¦è¡¨ç›˜_20241212.json` - å‘Šè­¦é¢æ¿

2. å¯¼å…¥æ­¥éª¤ï¼š
```bash
# é€šè¿‡Grafana UIå¯¼å…¥
1. ç™»å½•Grafana -> "+" -> Import
2. Upload JSON file -> é€‰æ‹©é¢æ¿æ–‡ä»¶
3. é€‰æ‹©Prometheusæ•°æ®æº
4. ç‚¹å‡»Importå®Œæˆ

# æˆ–é€šè¿‡APIå¯¼å…¥
curl -X POST http://grafana:3000/api/dashboards/db \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  -d @è¾¾æ¢¦DBç›‘æ§é¢æ¿_20250518.json
```

#### é¢æ¿å˜é‡é…ç½®
```json
// Dashboard Variables
{
  "datasource": {
    "query": "label_values(dm_up, datasource)",
    "multi": true,
    "includeAll": true
  },
  "interval": {
    "options": ["1m", "5m", "10m", "30m", "1h"],
    "default": "5m"
  },
  "env": {
    "query": "label_values(dm_up, env)",
    "multi": true
  }
}
```

### 8.2 AlertManageré…ç½®

#### å‘Šè­¦è·¯ç”±ç­–ç•¥
```yaml
# alertmanager.yml
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default-receiver'
  
  routes:
  # å…³é”®å‘Šè­¦ç«‹å³å‘é€
  - match:
      severity: critical
    receiver: critical-receiver
    group_wait: 0s
    repeat_interval: 5m
    
  # ç”Ÿäº§ç¯å¢ƒå‘Šè­¦
  - match:
      env: production
    receiver: production-receiver
    continue: true
    
  # é™é»˜æµ‹è¯•ç¯å¢ƒå¤œé—´å‘Šè­¦
  - match:
      env: test
    receiver: test-receiver
    mute_time_intervals:
      - night-silence

time_intervals:
  - name: night-silence
    time_intervals:
      - times:
        - start_time: '00:00'
          end_time: '06:00'
```

#### å‘Šè­¦æ¨¡æ¿å®šåˆ¶
```go
// alertmanager-template.tmpl
{{ define "dameng.title" }}
[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.alertname }}
{{ end }}

{{ define "dameng.text" }}
{{ range .Alerts }}
*å‘Šè­¦è¯¦æƒ…:*
{{ range .Labels.SortedPairs }}- {{ .Name }}: {{ .Value }}
{{ end }}
*æè¿°:* {{ .Annotations.description }}
*å¼€å§‹æ—¶é—´:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
{{ if ne .Status "firing" }}*æ¢å¤æ—¶é—´:* {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
---
{{ end }}
{{ end }}
```

### 8.3 ä¸å…¶ä»–ç›‘æ§ç³»ç»Ÿé›†æˆ

#### Zabbixé›†æˆ
```bash
# é€šè¿‡Zabbixå¤–éƒ¨è„šæœ¬é‡‡é›†
#!/bin/bash
# dameng_metrics.sh
curl -s http://localhost:9200/metrics | \
  grep "^dm_" | \
  awk '{print $1, $2}' | \
  while read metric value; do
    zabbix_sender -z zabbix.server -s "dameng.host" -k "$metric" -o "$value"
  done
```

#### ELKé›†æˆ
```yaml
# logstashé…ç½®
input {
  http_poller {
    urls => {
      dameng_metrics => "http://localhost:9200/metrics"
    }
    interval => 30
    codec => "plain"
  }
}

filter {
  grok {
    match => { 
      "message" => "^(?<metric_name>dm_[^{\s]+)(?:{(?<labels>[^}]+)})?\s+(?<value>[\d.]+)" 
    }
  }
  kv {
    source => "labels"
    field_split => ","
    value_split => "="
    trim_key => " "
    trim_value => '"'
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "dameng-metrics-%{+YYYY.MM.dd}"
  }
}
```

---

## 9. å®‰å…¨åŠ å›º

### 9.1 è®¿é—®æ§åˆ¶

#### ç½‘ç»œéš”ç¦»
```bash
# iptablesè§„åˆ™ç¤ºä¾‹
# åªå…è®¸PrometheusæœåŠ¡å™¨è®¿é—®
iptables -A INPUT -p tcp --dport 9200 -s prometheus.server.ip -j ACCEPT
iptables -A INPUT -p tcp --dport 9200 -j DROP

# æˆ–ä½¿ç”¨firewalld
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="prometheus.server.ip" port port="9200" protocol="tcp" accept'
firewall-cmd --reload
```

#### åå‘ä»£ç†é…ç½®
```nginx
# nginxé…ç½®ç¤ºä¾‹
server {
    listen 443 ssl;
    server_name dameng-exporter.example.com;
    
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # IPç™½åå•
    allow 10.0.0.0/8;
    allow 192.168.0.0/16;
    deny all;
    
    location /metrics {
        proxy_pass http://localhost:9200;
        proxy_set_header Host $host;
        
        # Basicè®¤è¯
        auth_basic "Restricted";
        auth_basic_user_file /etc/nginx/.htpasswd;
        
        # é™æµ
        limit_req zone=metrics_limit burst=10;
    }
}
```

### 9.2 å¯†ç ç®¡ç†æœ€ä½³å®è·µ

#### ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡
```toml
# é›†æˆHashiCorp Vault
[[datasource]]
name = "vault_integrated"
dbHost = "db.example.com:5236"
dbUser = "MONITOR"
# ä»Vaultè·å–å¯†ç 
vaultEnabled = true
vaultAddr = "https://vault.example.com:8200"
vaultPath = "secret/data/dameng/monitor"
vaultKey = "password"
```

#### å®šæœŸè½®æ¢å¯†ç 
```bash
#!/bin/bash
# rotate_password.sh
NEW_PWD=$(openssl rand -base64 32)

# æ›´æ–°æ•°æ®åº“å¯†ç 
sqlplus -s SYSDBA/current_pwd@db <<EOF
ALTER USER MONITOR IDENTIFIED BY "$NEW_PWD";
EOF

# åŠ å¯†æ–°å¯†ç 
ENCRYPTED_PWD=$(./dameng_exporter --encryptPwd="$NEW_PWD" | grep "Encrypted" | awk '{print $3}')

# æ›´æ–°é…ç½®æ–‡ä»¶
sed -i "s/dbPwd = .*/dbPwd = \"$ENCRYPTED_PWD\"/" dameng_exporter.toml

# é‡å¯æœåŠ¡
systemctl restart dameng_exporter
```

### 9.3 å®¡è®¡ä¸åˆè§„

#### å®¡è®¡æ—¥å¿—é…ç½®
```toml
# å¯ç”¨è¯¦ç»†å®¡è®¡æ—¥å¿—
logLevel = "debug"
auditEnabled = true
auditLogFile = "/var/log/dameng_exporter/audit.log"
auditLogMaxSize = 100
auditLogMaxBackups = 30
auditLogMaxAge = 90

# è®°å½•çš„å®¡è®¡äº‹ä»¶
auditEvents = [
  "authentication",
  "configuration_change",
  "metric_access",
  "error"
]
```

#### åˆè§„æ€§æ£€æŸ¥æ¸…å•
- [ ] æ‰€æœ‰å¯†ç å·²åŠ å¯†å­˜å‚¨
- [ ] å¯ç”¨HTTPS/TLSåŠ å¯†ä¼ è¾“
- [ ] é…ç½®è®¿é—®æ§åˆ¶å’Œè®¤è¯
- [ ] æœ€å°æƒé™åŸåˆ™ï¼ˆç›‘æ§è´¦å·ï¼‰
- [ ] å®šæœŸå®‰å…¨å®¡è®¡
- [ ] æ—¥å¿—ä¿ç•™æ»¡è¶³åˆè§„è¦æ±‚
- [ ] æ•æ„Ÿæ•°æ®è„±æ•å¤„ç†

### 9.4 å®‰å…¨åŠ å›ºæ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# security_check.sh

echo "=== DAMENG_EXPORTERå®‰å…¨æ£€æŸ¥ ==="

# æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™
if [ $(stat -c %a dameng_exporter.toml) != "600" ]; then
    echo "[!] é…ç½®æ–‡ä»¶æƒé™ä¸å®‰å…¨"
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ–‡å¯†ç 
if grep -q 'dbPwd = "[^E][^N][^C]' dameng_exporter.toml; then
    echo "[!] æ£€æµ‹åˆ°æ˜æ–‡å¯†ç "
fi

# æ£€æŸ¥æ˜¯å¦å¯ç”¨è®¤è¯
if ! grep -q 'enableBasicAuth = true' dameng_exporter.toml; then
    echo "[!] æœªå¯ç”¨Basicè®¤è¯"
fi

# æ£€æŸ¥TLSé…ç½®
if ! grep -q 'enableTLS = true' dameng_exporter.toml; then
    echo "[!] æœªå¯ç”¨TLSåŠ å¯†"
fi

# æ£€æŸ¥ç›‘æ§è´¦å·æƒé™
echo "[*] è¯·æ‰‹åŠ¨æ£€æŸ¥æ•°æ®åº“ç›‘æ§è´¦å·æƒé™æ˜¯å¦ç¬¦åˆæœ€å°æƒé™åŸåˆ™"

echo "=== æ£€æŸ¥å®Œæˆ ==="
```

---

## é™„å½•Dï¼šé”™è¯¯ä»£ç è¯´æ˜

### æ•°æ®åº“è¿æ¥é”™è¯¯

| é”™è¯¯ä»£ç  | è¯´æ˜ | è§£å†³æ–¹æ³• |
|---------|------|----------|
| -2501 | ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ | æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡® |
| -2502 | è¿æ¥è¶…æ—¶ | æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´ |
| -2503 | æ•°æ®åº“æœªå¯åŠ¨ | ç¡®è®¤æ•°æ®åº“æœåŠ¡å·²å¯åŠ¨ |
| -2504 | ç›‘å¬åœ°å€é”™è¯¯ | æ£€æŸ¥dbHostå‚æ•°æ ¼å¼ |
| -2505 | æƒé™ä¸è¶³ | æ£€æŸ¥ç”¨æˆ·æƒé™ |

### é…ç½®é”™è¯¯

| é”™è¯¯ä¿¡æ¯ | è¯´æ˜ | è§£å†³æ–¹æ³• |
|---------|------|----------|
| Config file not found | é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ | æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„ |
| Failed to parse config file as TOML | TOMLæ ¼å¼é”™è¯¯ | æ£€æŸ¥TOMLè¯­æ³• |
| Duplicate datasource name | æ•°æ®æºåç§°é‡å¤ | ç¡®ä¿nameå”¯ä¸€ |
| Database connection parameters incomplete | å‚æ•°ä¸å®Œæ•´ | åŒæ—¶æŒ‡å®šä¸‰ä¸ªå‚æ•° |

### è¿è¡Œæ—¶é”™è¯¯

| é”™è¯¯ç±»å‹ | è¯´æ˜ | è§£å†³æ–¹æ³• |
|---------|------|----------|
| bind: address already in use | ç«¯å£è¢«å ç”¨ | æ›´æ¢ç«¯å£æˆ–åœæ­¢å ç”¨è¿›ç¨‹ |
| connection pool exhausted | è¿æ¥æ± è€—å°½ | å¢åŠ maxOpenConns |
| query timeout | æŸ¥è¯¢è¶…æ—¶ | å¢åŠ queryTimeoutæˆ–ä¼˜åŒ–æŸ¥è¯¢ |
| permission denied | æƒé™ä¸è¶³ | æ£€æŸ¥æ–‡ä»¶æˆ–ç›®å½•æƒé™ |

---

## ç‰ˆæœ¬å†å²

### v1.2.0 (2025-09-03)
- ç§»é™¤å‘½ä»¤è¡Œå‚æ•°é»˜è®¤å€¼
- æ”¯æŒå¤šæ•°æ®æºç›‘æ§
- ä¼˜åŒ–é…ç½®åŠ è½½é€»è¾‘
- å¢å¼ºå¯†ç åŠ å¯†åŠŸèƒ½

### v1.1.0 (2024-12-01)
- æ·»åŠ æ…¢SQLç›‘æ§
- æ”¯æŒBasic Authè®¤è¯
- ä¼˜åŒ–è¿æ¥æ± ç®¡ç†

### v1.0.0 (2024-06-01)
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- åŸºç¡€ç›‘æ§åŠŸèƒ½
- æ”¯æŒé…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°

---

## è”ç³»ä¸æ”¯æŒ

- GitHub: https://github.com/gaoyuan98/dameng_exporter
- Issues: https://github.com/gaoyuan98/dameng_exporter/issues
- æ–‡æ¡£: https://github.com/gaoyuan98/dameng_exporter/wiki

---

**å£°æ˜ï¼š** æœ¬æ‰‹å†ŒåŸºäº v1.2.0 ç‰ˆæœ¬ç¼–å†™ï¼Œåç»­ç‰ˆæœ¬å¯èƒ½æœ‰æ‰€å˜æ›´ï¼Œè¯·ä»¥æœ€æ–°æ–‡æ¡£ä¸ºå‡†ã€‚
