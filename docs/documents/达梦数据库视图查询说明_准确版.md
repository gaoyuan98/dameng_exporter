# 达梦数据库监控视图查询说明（完整版）

## 概述

本文档基于dameng_exporter中的实际SQL查询语句，准确记录了每个监控指标对应的数据库视图、查询方式、返回值含义及指标解释。

## 核心监控指标详细说明

### 1. 实例状态监控 (QueryDBInstanceRunningInfoSqlStr)

**用途**：监控数据库实例的运行状态、模式、事务、锁等核心信息

**实际SQL语句**：
```sql
SELECT /*+DAMENG_EXPORTER*/
       TO_CHAR(START_TIME,'YYYY-MM-DD HH24:MI:SS'),
       CASE STATUS$ WHEN 'OPEN' THEN '1' WHEN 'MOUNT' THEN '2' WHEN 'SUSPEND' THEN '3' ELSE '4' END AS STATUS,
       CASE MODE$ WHEN 'PRIMARY' THEN '1' WHEN 'NORMAL' THEN '2' WHEN 'STANDBY' THEN '3' ELSE '4' END AS MODE,
       (SELECT COUNT(*) FROM V$TRXWAIT) TRXNUM,
       (SELECT COUNT(*) FROM V$LOCK WHERE BLOCKED=1) DEADLOCKNUM,
       (SELECT COUNT(*) FROM V$THREADS) THREADSNUM,
       DATEDIFF(SQL_TSI_DAY,START_TIME,sysdate) DBSTARTDAY
FROM V$INSTANCE
```

| 字段名 | 查询来源 | 返回值说明 | 指标含义 |
|--------|----------|------------|----------|
| START_TIME | `V$INSTANCE.START_TIME` | YYYY-MM-DD HH24:MI:SS格式的时间字符串 | 数据库实例启动时间 |
| STATUS | `V$INSTANCE.STATUS$` | 1=OPEN（正常运行）<br>2=MOUNT（挂载）<br>3=SUSPEND（挂起）<br>4=其他状态 | 数据库当前运行状态 |
| MODE | `V$INSTANCE.MODE$` | 1=PRIMARY（主库）<br>2=NORMAL（普通）<br>3=STANDBY（备库）<br>4=其他模式 | 数据库运行模式 |
| TRXNUM | `COUNT(*) FROM V$TRXWAIT` | 整数，等待中的事务数量 | 当前等待资源的事务数，反映系统并发压力 |
| DEADLOCKNUM | `COUNT(*) FROM V$LOCK WHERE BLOCKED=1` | 整数，被阻塞的锁数量 | 活动会话事务等待数（非死锁数） |
| THREADSNUM | `COUNT(*) FROM V$THREADS` | 整数，线程总数 | 数据库当前线程数 |
| DBSTARTDAY | `DATEDIFF(SQL_TSI_DAY,START_TIME,sysdate)` | 整数，天数 | 数据库已运行天数 |

### 2. 会话状态监控 (QueryDBSessionsStatusSqlStr)

**用途**：监控数据库会话连接状态和使用情况

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/
        DECODE(STATE, NULL, 'UNKNOWN', STATE) AS STATE_TYPE,
        COUNT(SESS_ID) AS COUNT_VAL
FROM V$SESSIONS
GROUP BY STATE;
```

| 返回字段 | 含义 | 返回值说明 |
|----------|------|------------|
| STATE_TYPE | 会话状态类型 | ACTIVE=活动会话<br>IDLE=空闲会话<br>KILLED/WAITING/...=数据库实际存在的所有会话状态<br>UNKNOWN=STATE字段为空时的占位值 |
| COUNT_VAL | 计数值 | 对应状态的会话数量 |

### 3. 内存池监控 (QueryMemoryPoolInfoSqlStr)

**用途**：监控数据库内存池的使用情况

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ ZONE_TYPE,CURR_VAL,RES_VAL,TOTAL_VAL FROM (
  SELECT 'HJ ZONE' AS ZONE_TYPE,
         (SELECT SUM(STAT_VAL) FROM V$SYSSTAT WHERE ID IN (114,115)) AS CURR_VAL,
         (SELECT STAT_VAL FROM V$SYSSTAT WHERE ID IN (145)) AS RES_VAL,
         (SELECT STAT_VAL FROM V$SYSSTAT WHERE ID IN (144)) AS TOTAL_VAL 
  FROM DUAL 
  UNION ALL
  SELECT 'HAGR ZONE',
         (SELECT SUM(STAT_VAL) FROM V$SYSSTAT WHERE ID IN (116)),
         (SELECT STAT_VAL FROM V$SYSSTAT WHERE ID IN (143)),
         (SELECT STAT_VAL FROM V$SYSSTAT WHERE ID IN (142)) 
  FROM DUAL 
  UNION ALL
  SELECT 'SORT ZONE',
         (SELECT SUM(STAT_VAL) FROM V$SYSSTAT WHERE ID IN (178)),
         NULL,
         (SELECT STAT_VAL FROM V$SYSSTAT WHERE ID IN (177)) 
  FROM DUAL
)
```

| 内存区域 | V$SYSSTAT ID | 返回字段 | 含义 |
|----------|--------------|----------|------|
| HJ ZONE（Hash Join内存区） | 114,115（当前值）<br>145（保留值）<br>144（总值） | CURR_VAL<br>RES_VAL<br>TOTAL_VAL | 当前使用量<br>保留量<br>总容量 |
| HAGR ZONE（Hash聚合内存区） | 116（当前值）<br>143（保留值）<br>142（总值） | 同上 | 同上 |
| SORT ZONE（排序内存区） | 178（当前值）<br>177（总值） | CURR_VAL<br>TOTAL_VAL | 当前使用量<br>总容量（无保留值） |

**单位**：字节

### 4. 表空间监控 (QueryTablespaceInfoSqlStr)

**用途**：监控表空间使用率，预防空间不足

**实际SQL语句**：
```sql
SELECT /*+DAMENG_EXPORTER*/ 
    F.TABLESPACE_NAME,
    T.TOTAL_SPACE "TOTAL_SIZE",
    F.FREE_SPACE AS "FREE_SIZE"
FROM (
    SELECT TABLESPACE_NAME, 
           ROUND(SUM(BLOCKS * (SELECT PARA_VALUE / 1024 FROM V$DM_INI WHERE PARA_NAME = 'GLOBAL_PAGE_SIZE') / 1024)) FREE_SPACE
    FROM DBA_FREE_SPACE
    GROUP BY TABLESPACE_NAME
) F,
(
    SELECT TABLESPACE_NAME, 
           ROUND(SUM(BYTES / 1048576)) TOTAL_SPACE
    FROM DBA_DATA_FILES
    GROUP BY TABLESPACE_NAME
) T
WHERE F.TABLESPACE_NAME = T.TABLESPACE_NAME
```

| 字段名 | 计算方式 | 返回值说明 | 指标含义 |
|--------|----------|------------|----------|
| TABLESPACE_NAME | 直接获取 | 表空间名称 | 表空间标识 |
| TOTAL_SIZE | `SUM(BYTES / 1048576)` from DBA_DATA_FILES | 数值（MB） | 表空间总大小 |
| FREE_SIZE | `SUM(BLOCKS * PAGE_SIZE / 1024 / 1024)` from DBA_FREE_SPACE | 数值（MB） | 表空间剩余空间 |

### 5. 表空间数据文件 (QueryTablespaceFileSqlStr)

**用途**：监控数据文件的详细信息

**实际SQL语句**：
```sql
SELECT /*+DAMENG_EXPORTER*/ 
    PATH,
    TO_CHAR(TOTAL_SIZE*PAGE) AS TOTAL_SIZE,
    TO_CHAR(FREE_SIZE*PAGE) AS FREE_SIZE,
    AUTO_EXTEND,
    NEXT_SIZE,
    MAX_SIZE
FROM V$DATAFILE
```

| 字段名 | 来源 | 返回值说明 |
|--------|------|------------|
| PATH | V$DATAFILE.PATH | 数据文件路径 |
| TOTAL_SIZE | TOTAL_SIZE*PAGE | 文件总大小（字节） |
| FREE_SIZE | FREE_SIZE*PAGE | 文件空闲大小（字节） |
| AUTO_EXTEND | V$DATAFILE.AUTO_EXTEND | 是否自动扩展 |
| NEXT_SIZE | V$DATAFILE.NEXT_SIZE | 下次扩展大小 |
| MAX_SIZE | V$DATAFILE.MAX_SIZE | 最大文件大小 |

### 6. FAST缓冲池命中率 (QueryBufferPoolHitRateInfoSql)

**用途**：监控缓冲池效率，命中率越高性能越好

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    NAME,
    ROUND(SUM(RAT_HIT) /COUNT(*),4) HIT_RATE 
FROM V$BUFFERPOOL 
WHERE NAME ='FAST' 
GROUP BY NAME
```

| 字段名 | 计算方式 | 返回值说明 | 指标含义 |
|--------|----------|------------|----------|
| NAME | 直接获取 | 'FAST' | 缓冲池名称 |
| HIT_RATE | `ROUND(SUM(RAT_HIT)/COUNT(*),4)` | 0.0000-1.0000 | 缓冲池命中率（建议>0.95） |

### 7. SQL语句执行统计 (QuerySqlExecuteCountSqlStr)

**用途**：统计各类SQL语句执行情况，分析数据库负载特征

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    NAME,
    STAT_VAL 
FROM v$sysstat 
WHERE name IN (
    'select statements','insert statements','delete statements','update statements',
    'ddl statements','transaction total count','select statements in pl/sql',
    'insert statements in pl/sql','delete statements in pl/sql','update statements in pl/sql',
    'DDL in pl/sql count','dynamic exec in pl/sql','DB time(ms)','parse time(ms)',
    'hard parse time(ms)','latch wait time(ms)','mutex wait time(ms)','io wait time(ms)',
    'trx lock wait time(ms)','redo sync wait time(ms)','redo sync wait time for commit(ms)',
    'parse count','parser errors','hard parse count','plan total count',
    'plan cache hit count','logic read count','recycle logic read count',
    'physical read count','physical multi read count','physical write count'
)
```

| 统计项 | 含义 | 单位 |
|--------|------|------|
| select statements | SELECT语句执行次数 | 次 |
| insert/delete/update statements | DML语句执行次数 | 次 |
| ddl statements | DDL语句执行次数 | 次 |
| transaction total count | 事务总数 | 个 |
| DB time(ms) | 数据库总耗时 | 毫秒 |
| parse time(ms) | SQL解析时间 | 毫秒 |
| io wait time(ms) | IO等待时间 | 毫秒 |
| logic read count | 逻辑读次数 | 次 |
| physical read count | 物理读次数 | 次 |

### 8. 慢SQL查询 (QueryDbSlowSqlInfoSqlStr)

**用途**：发现和分析慢查询，优化数据库性能

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ * FROM (
    SELECT DATEDIFF(MS,LAST_RECV_TIME,SYSDATE) EXEC_TIME,
           DBMS_LOB.SUBSTR(SF_GET_SESSION_SQL(SESS_ID)) SLOW_SQL,
           SESS_ID,
           CURR_SCH,
           THRD_ID,
           LAST_RECV_TIME,
           SUBSTR(CLNT_IP,8,13) CONN_IP
    FROM V$SESSIONS
    WHERE 1=1 AND STATE='ACTIVE'
    ORDER BY 1 DESC
) 
WHERE EXEC_TIME >= ? 
  AND LAST_RECV_TIME > TO_TIMESTAMP('2000-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
LIMIT ?
```

| 字段名 | 计算方式 | 返回值说明 | 指标含义 |
|--------|----------|------------|----------|
| EXEC_TIME | `DATEDIFF(MS,LAST_RECV_TIME,SYSDATE)` | 毫秒数 | SQL执行时间 |
| SLOW_SQL | `DBMS_LOB.SUBSTR(SF_GET_SESSION_SQL(SESS_ID))` | SQL文本 | 慢查询语句 |
| SESS_ID | V$SESSIONS.SESS_ID | 会话ID | 执行SQL的会话标识 |
| CURR_SCH | V$SESSIONS.CURR_SCH | 当前模式 | 执行SQL的模式 |
| CONN_IP | `SUBSTR(CLNT_IP,8,13)` | IP地址 | 客户端连接IP |

### 9. 监视器信息 (QueryMonitorInfoSqlStr)

**用途**：监控数据库监视器连接状态

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    TO_CHAR(DW_CONN_TIME,'YYYY-MM-DD HH24:MI:SS') AS DW_CONN_TIME,
    MON_CONFIRM,
    MON_ID,
    MON_IP,
    MON_VERSION,
    MID 
FROM V$DMMONITOR
```

| 字段名 | 来源 | 返回值说明 |
|--------|------|------------|
| DW_CONN_TIME | V$DMMONITOR.DW_CONN_TIME | 监视器连接时间 |
| MON_CONFIRM | V$DMMONITOR.MON_CONFIRM | 确认状态 |
| MON_ID | V$DMMONITOR.MON_ID | 监视器ID |
| MON_IP | V$DMMONITOR.MON_IP | 监视器IP |
| MON_VERSION | V$DMMONITOR.MON_VERSION | 监视器版本 |

### 10. 数据库参数 (QueryParameterInfoSql)

**用途**：获取关键数据库参数配置

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    para_name,
    para_value 
FROM v$dm_ini 
WHERE para_name IN ('MAX_SESSIONS','REDOS_BUF_NUM','REDOS_BUF_SIZE','PORT_NUM')
```

| 参数名 | 含义 | 典型值 |
|--------|------|--------|
| MAX_SESSIONS | 最大会话数 | 1000 |
| REDOS_BUF_NUM | 重做缓冲区数量 | 256 |
| REDOS_BUF_SIZE | 重做缓冲区大小 | 32MB |
| PORT_NUM | 数据库端口号 | 5236 |

### 11. 检查点信息 (QueryCheckPointInfoSql)

**用途**：监控检查点执行情况，评估IO性能

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    CKPT_TOTAL_COUNT,
    CKPT_RESERVE_COUNT,
    CKPT_FLUSHED_PAGES,
    CKPT_TIME_USED 
FROM V$CKPT
```

| 字段名 | 含义 | 单位 | 说明 |
|--------|------|------|------|
| CKPT_TOTAL_COUNT | 检查点执行总次数 | 次 | 累计值，持续增长 |
| CKPT_RESERVE_COUNT | 保留的检查点数 | 个 | 当前保留的检查点数量 |
| CKPT_FLUSHED_PAGES | 检查点刷新页数 | 页 | 累计刷新的数据页数 |
| CKPT_TIME_USED | 检查点耗时 | 毫秒 | 累计耗时 |

### 11.1. REDO 日志 LSN 信息 (QueryRedoLogLsnInfoSql)

**用途**：实时观察 redo 日志推进进度，判断检查点、刷盘与当前写入位置之间的差距

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/
    CKPT_LSN,
    FILE_LSN,
    FLUSH_LSN,
    CUR_LSN
FROM V$RLOG
```

| 字段名 | 含义 | 说明 |
|--------|------|------|
| CKPT_LSN | 最近一次检查点已落盘的 LSN | 反映检查点刷新的位置，上报为 counter 指标 |
| FILE_LSN | 最新写入磁盘的日志文件 LSN | 标识 redo 文件的持久化进度 |
| FLUSH_LSN | 即将刷盘的 LSN | 预期下一次 flush 会推进到的位置，可衡量脏页待刷范围 |
| CUR_LSN | 当前生成的 LSN | 代表实例内存中最新的 LSN，持续递增 |

Exporter 指标：`dmdbms_rlog_lsn_total{lsn_type="CKPT_LSN|FILE_LSN|FLUSH_LSN|CUR_LSN"}`。

### 12. 用户信息 (QueryUserInfoSqlStr)

**用途**：监控数据库用户状态和权限

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    A.USERNAME,
    CASE B.RN_FLAG WHEN '0' THEN 'N' WHEN '1' THEN 'Y' END AS READ_ONLY,
    CASE A.ACCOUNT_STATUS WHEN 'LOCKED' THEN '锁定' WHEN 'OPEN' THEN '正常' ELSE '异常' END AS ACCOUNT_STATUS,
    TO_CHAR(A.EXPIRY_DATE,'YYYY-MM-DD HH24:MI:SS') AS EXPIRY_DATE,
    TO_CHAR(ROUND(DATEDIFF(DAY,TO_CHAR(sysdate,'YYYY-MM-DD HH24:MI:SS'),TO_CHAR(A.EXPIRY_DATE,'YYYY-MM-DD HH24:MI:SS')),2)) AS EXPIRY_DATE_DAY,
    A.DEFAULT_TABLESPACE,
    A.PROFILE,
    TO_CHAR(A.CREATED,'YYYY-MM-DD HH24:MI:SS') AS CREATE_TIME
FROM DBA_USERS A, SYSUSERS B 
WHERE A.USER_ID=B.ID AND A.USERNAME NOT IN('SYS','SYSSSO','SYSAUDITOR')
```

| 字段名 | 计算方式 | 返回值说明 |
|--------|----------|------------|
| USERNAME | DBA_USERS.USERNAME | 用户名 |
| READ_ONLY | SYSUSERS.RN_FLAG | Y=只读用户，N=可写用户 |
| ACCOUNT_STATUS | DBA_USERS.ACCOUNT_STATUS | 锁定/正常/异常 |
| EXPIRY_DATE_DAY | `datediff(DAY,sysdate,EXPIRY_DATE)` | 密码剩余有效天数 |

### 13. 数据库授权 (QueryDbGrantInfoSql)

**用途**：监控数据库授权到期时间

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    CASE WHEN expired_date IS NULL THEN '' 
         ELSE TO_CHAR(expired_date, 'yyyyMMdd')  
    END AS expired_date 
FROM V$LICENSE
```

| 字段名 | 返回值说明 | 指标含义 |
|--------|------------|----------|
| expired_date | yyyyMMdd格式日期或空字符串 | 授权到期日期，空表示永久授权 |

### 14. 待PURGE事务 (QueryPurgeInfoSqlStr)

**用途**：监控回滚段清理状态

**实际SQL语句**：
```sql
SELECT /*+DAMENG_EXPORTER*/ 
    OBJ_NUM,
    IS_RUNNING,
    PURG_FOR_TS 
FROM V$PURGE
```

| 字段名 | 含义 | 返回值说明 |
|--------|------|------------|
| OBJ_NUM | 待清理对象数 | 整数，待PURGE的对象数量 |
| IS_RUNNING | PURGE运行状态 | 1=正在运行，0=未运行 |
| PURG_FOR_TS | 目标表空间 | PURGE操作的目标表空间名 |

### 15. 系统资源信息 (QuerySystemInfoSqlStr)

**用途**：监控服务器硬件资源

**实际SQL语句**：
```sql
SELECT /*+DAMENG_EXPORTER*/ 
    N_CPU,
    TOTAL_PHY_SIZE,
    TOTAL_VIR_SIZE,
    TOTAL_DISK_SIZE 
FROM V$SYSTEMINFO 
WHERE ROWNUM = 1
```

| 字段名 | 含义 | 单位 | 说明 |
|--------|------|------|------|
| N_CPU | CPU核心数 | 个 | 服务器CPU核心总数 |
| TOTAL_PHY_SIZE | 物理内存 | 字节 | 服务器物理内存总量 |
| TOTAL_VIR_SIZE | 虚拟内存 | 字节 | 服务器虚拟内存总量 |
| TOTAL_DISK_SIZE | 磁盘空间 | 字节 | 服务器磁盘总容量 |

### 16. 版本信息 (QueryVersionInfoSqlStr)

**用途**：获取数据库版本信息

**实际SQL语句**：
```sql
SELECT /*+DAMENG_EXPORTER*/ 
    ID_CODE,
    BUILD_TYPE,
    TO_NUMBER(SUBSTR(VER,1,2),'XX')
    ||'.'||TO_NUMBER(SUBSTR(VER,3,2),'XX')
    ||'.'||TO_NUMBER(SUBSTR(VER,5,2),'XX')
    ||'.'||TO_NUMBER(SUBSTR(VER,7,2),'XX') AS INNER_VER
FROM (
    SELECT DECODE(SUBSTR(VER,1,2),'03','企业版','05','安全版','02','标准版','其他') AS BUILD_TYPE,
           RAWTOHEX(CAST(SUBSTR(VER,3) AS INT)) AS VER
    FROM (SELECT REGEXP_SUBSTR(ID_CODE,'[^-]+',1,1) AS VER)
)
```

| 字段名 | 含义 | 返回值示例 |
|--------|------|-------------|
| ID_CODE | 原始版本代码 | DM Database Server... |
| BUILD_TYPE | 版本类型 | 企业版/安全版/标准版/其他 |
| INNER_VER | 内部版本号 | 8.1.2.128 |

### 17. 定时作业错误 (QueryDbJobRunningInfoSqlStr)

**用途**：监控定时作业执行错误

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ COUNT(*) error_num FROM (
    SELECT NAME,ERRINFO FROM SYSJOB.SYSJOBHISTORIES2 
    WHERE ERRCODE !=0 AND START_TIME >= (SYSDATE-31) 
    AND NAME IN (
        SELECT SYSJOBS.NAME
        FROM SYSJOB.SYSJOBSCHEDULES SCHE
        LEFT JOIN SYSJOB.USER_JOBS USERJOB ON SCHE.JOBID = USERJOB.JOB 
        LEFT JOIN SYSJOB.SYSJOBSTEPS STEPS ON SCHE.JOBID = STEPS.JOBID 
        LEFT JOIN SYSJOB.SYSJOBS SYSJOBS ON SCHE.JOBID = SYSJOBS.ID       
        WHERE STEPS."TYPE" = 6 AND SCHE.VALID = 'Y'
        GROUP BY SYSJOBS.NAME
    )
    UNION ALL
    SELECT NAME,ERRINFO FROM SYSJOB.SYSSTEPHISTORIES2 
    WHERE ERRCODE !=0 AND START_TIME >= (SYSDATE-31) 
    AND NAME IN (
        SELECT SYSJOBS.NAME
        FROM SYSJOB.SYSJOBSCHEDULES SCHE 
        LEFT JOIN SYSJOB.USER_JOBS USERJOB ON SCHE.JOBID = USERJOB.JOB 
        LEFT JOIN SYSJOB.SYSJOBSTEPS STEPS ON SCHE.JOBID = STEPS.JOBID 
        LEFT JOIN SYSJOB.SYSJOBS SYSJOBS ON SCHE.JOBID = SYSJOBS.ID       
        WHERE STEPS."TYPE" = 6 AND SCHE.VALID = 'Y' 
        GROUP BY SYSJOBS.NAME
    )
)
```

**查询逻辑**：
- 查询 `SYSJOB.SYSJOBHISTORIES2` 和 `SYSJOB.SYSSTEPHISTORIES2` 表
- 筛选条件：`ERRCODE != 0` 且 `START_TIME >= (SYSDATE-31)`
- 只统计TYPE=6且VALID='Y'的作业
- 返回：最近31天内的错误总数

### 18. 守护进程状态 (QueryDwWatcherInfoSql)

**用途**：监控守护进程运行状态

**实际SQL语句**：
```sql
SELECT /*+DMDB_CHECK_FLAG*/ 
    WATCHER.DW_MODE,
    WATCHER.DW_STATUS,
    WATCHER.AUTO_RESTART,
    CASE WATCHER.DW_STATUS 
        WHEN 'OPEN' THEN '1' 
        WHEN 'MOUNT' THEN '2' 
        WHEN 'SUSPEND' THEN '3' 
        ELSE '4' 
    END AS DW_STATUS_TO_NUM 
FROM V$DMWATCHER WATCHER 
LEFT JOIN V$INSTANCE INSTANCE ON INSTANCE.INSTANCE_NAME = WATCHER.INST_NAME
```

| 字段名 | 含义 | 返回值说明 |
|--------|------|------------|
| DW_MODE | 守护模式 | 守护进程工作模式 |
| DW_STATUS | 守护状态 | OPEN/MOUNT/SUSPEND/其他 |
| AUTO_RESTART | 自动重启 | 是否自动重启 |
| DW_STATUS_TO_NUM | 状态数值 | 1=OPEN，2=MOUNT，3=SUSPEND，4=其他 |

### 19. 归档相关监控

#### 最新归档创建时间 (QueryArchiveLatestCreateTimeSql)

**用途**：获取最新归档日志的创建时间戳，供表盘计算距上次切换的时间间隔

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    TO_CHAR(CREATE_TIME,'YYYY-MM-DD HH24:MI:SS') AS CREATE_TIME
FROM V$ARCH_FILE 
ORDER BY create_time DESC 
LIMIT 1
```

| 字段名 | 含义 | 说明 |
|--------|------|------|
| CREATE_TIME | 创建时间 | 最新归档文件创建时间（字符串，格式YYYY-MM-DD HH24:MI:SS） |

Exporter 指标：`dmdbms_arch_last_create_time_seconds`（以 Unix 秒表示，仪表盘通过 `time() - 指标值` 计算距上次归档切换的秒数）。

#### 归档发送状态 (QueryArchiveSendStatusSql)

**实际SQL语句**：
```sql
SELECT /*+DMDB_CHECK_FLAG*/ 
    CASE ARCH_STATUS WHEN 'VALID' THEN 1 WHEN 'INVALID' THEN 0 END ARCH_STATUS,
    ARCH_TYPE,
    ARCH_DEST,
    ARCH_SRC 
FROM v$arch_status
```

| 字段名 | 含义 | 返回值说明 |
|--------|------|------------|
| ARCH_STATUS | 归档状态 | 1=VALID（有效），0=INVALID（无效） |
| ARCH_TYPE | 归档类型 | LOCAL/REMOTE等 |
| ARCH_DEST | 归档目的地 | 归档发送目标 |
| ARCH_SRC | 归档源 | 归档来源 |

#### 归档LSN详情 (QueryArchSendDetailInfo)

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    ARCH_DEST,
    ARCH_TYPE,
    (MAX_SEND_LSN - LAST_SEND_LSN) AS LSN_DIFFERENCE,
    LAST_SEND_CODE,
    LAST_SEND_DESC,
    TO_CHAR(LAST_START_TIME,'YYYY-MM-DD HH24:MI:SS') AS LAST_START_TIME,
    TO_CHAR(LAST_END_TIME,'YYYY-MM-DD HH24:MI:SS') AS LAST_END_TIME,
    LAST_SEND_TIME 
FROM V$ARCH_SEND_INFO
```

| 字段名 | 含义 | 说明 |
|--------|------|------|
| LSN_DIFFERENCE | LSN差值 | MAX_SEND_LSN - LAST_SEND_LSN，表示待发送量 |
| LAST_SEND_CODE | 最后发送代码 | 发送结果代码 |
| LAST_SEND_DESC | 最后发送描述 | 发送结果描述 |
| LAST_SEND_TIME | 发送耗时 | 最后一次发送耗时 |

#### REDO 切换最新时间 (QueryRedoLogHistorySql)

**用途**：监控 V$LOG_HISTORY 中最新一次 redo 日志切换时间，供表盘计算距当前的间隔

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    TO_CHAR(RECTIME,'YYYY-MM-DD HH24:MI:SS') AS RECTIME
FROM V$LOG_HISTORY 
ORDER BY RECTIME DESC 
LIMIT 1
```

| 字段名 | 含义 | 说明 |
|--------|------|------|
| RECTIME | 切换时间 | 最近一次 redo 日志切换时间（字符串，格式YYYY-MM-DD HH24:MI:SS） |

Exporter 指标：`dmdbms_redo_last_switch_time_seconds`（以 Unix 秒表示；若查询不到记录则返回0，Grafana 端可通过 `time() - 指标值` 计算切换间隔）。

### 20. 主备库同步监控

#### 备库重做信息 (QueryStandbyInfoSql)

**用途**：监控备库重做日志处理状态

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    task_mem_used, 
    task_num 
FROM v$rapply_sys
```

| 字段名 | 含义 | 单位 |
|--------|------|------|
| task_mem_used | 任务内存使用 | 字节 |
| task_num | 任务线程数 | 个 |

#### 同步延迟监控 (QueryRapplyTimeDiffSql)

**用途**：监控主备库同步延迟

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    NVL(TIMESTAMPDIFF(SQL_TSI_SECOND, APPLY_CMT_TIME, LAST_CMT_TIME), 0) TIMEDIFF 
FROM V$RAPPLY_STAT
```

| 字段名 | 计算方式 | 含义 |
|--------|----------|------|
| TIMEDIFF | `TIMESTAMPDIFF(SQL_TSI_SECOND, APPLY_CMT_TIME, LAST_CMT_TIME)` | 主备同步延迟（秒） |

### 21. 实例错误日志 (QueryInstanceErrorLogSql)

**用途**：监控最近的数据库错误

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    TO_CHAR(LOG_TIME,'YYYY-MM-DD HH24:MI:SS') AS LOG_TIME,
    PID,
    LEVEL$ AS LEVEL,
    TXT 
FROM V$INSTANCE_LOG_HISTORY 
WHERE DATEDIFF(MINUTE, LOG_TIME, GETDATE()) <= 5 
  AND LEVEL$ NOT IN ('INFO','WARN') 
ORDER BY SEQNO DESC
```

**查询条件**：
- 时间范围：最近5分钟内
- 日志级别：排除INFO和WARN，只查询ERROR级别以上
- 排序：按SEQNO降序

| 字段名 | 含义 |
|--------|------|
| LOG_TIME | 日志时间 |
| PID | 进程ID |
| LEVEL | 日志级别 |
| TXT | 日志内容 |

### 22. 数据字典缓存 (QueryDictCacheInfoSql)

**用途**：监控数据字典缓存效率

**实际SQL语句**：
```sql
SELECT /*+DM_EXPORTER*/ 
    LRU_DISCARD, 
    DDL_DISCARD, 
    DISABLED_DICT_NUM 
FROM V$DB_CACHE
```

| 字段名 | 含义 | 说明 |
|--------|------|------|
| LRU_DISCARD | LRU淘汰次数 | 由于缓存池已满导致字典对象被淘汰的次数 |
| DDL_DISCARD | DDL淘汰次数 | DDL操作导致字典对象被淘汰的次数 |
| DISABLED_DICT_NUM | 淘汰对象总数 | 缓存池中被淘汰字典对象的累计总数 |

### 23. 视图和字段存在性检查

#### 检查V$ARCH_APPLY_INFO视图

**实际SQL语句**：
```sql
SELECT COUNT(1) 
FROM V$DYNAMIC_TABLES 
WHERE NAME = 'V$ARCH_APPLY_INFO'
```

#### 检查V$ARCH_SEND_INFO字段

**实际SQL语句**：
```sql
SELECT COUNT(*) 
FROM V$DYNAMIC_TABLE_COLUMNS 
WHERE TABNAME = 'V$ARCH_SEND_INFO' 
  AND COLNAME IN ('LAST_SEND_CODE','LAST_SEND_DESC')
```

#### 检查V$DB_CACHE字段

**实际SQL语句**：
```sql
SELECT COUNT(*) 
FROM V$DYNAMIC_TABLE_COLUMNS 
WHERE TABNAME = 'V$DB_CACHE' 
  AND COLNAME IN ('LRU_DISCARD', 'DDL_DISCARD', 'DISABLED_DICT_NUM')
```

## 性能优化建议

### 关键指标阈值参考

| 指标 | 建议阈值 | 告警级别 |
|------|---------|----------|
| FAST缓冲池命中率 | >95% | <90%告警 |
| 表空间使用率 | <80% | >90%告警 |
| 会话使用率 | <70% | >80%告警 |
| 锁等待数 | <10 | >50告警 |
| 慢SQL执行时间 | <5000ms | >10000ms告警 |
| 主备同步延迟 | <60秒 | >300秒告警 |


---

**更新日期**：2025-09-02  
**版本**：v1.0（包含完整SQL语句版）  
**说明**：本文档完整记录了所有监控指标的SQL查询语句、返回值含义和使用建议
