# Dameng Exporter 自定义指标使用指南

## 目录

- [概述](#概述)
- [快速开始](#快速开始)
- [配置文件格式](#配置文件格式)
- [参数详解](#参数详解)
- [实用示例](#实用示例)
  - [基础示例](#基础示例)
  - [性能监控](#性能监控)
  - [业务指标](#业务指标)
  - [安全审计](#安全审计)
- [高级用法](#高级用法)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)
- [调试技巧](#调试技巧)

## 概述

自定义指标功能允许用户通过 SQL 查询定义自己的监控指标，无需修改 Exporter 源代码。这为监控特定业务逻辑、定制化性能指标提供了极大的灵活性。

### 核心特性

- ✅ **灵活定义** - 通过 SQL 查询自由定义指标
- ✅ **统一配置** - 在数据源中独立指定指标文件，重启 Exporter 后生效
- ✅ **类型支持** - 支持 Counter 和 Gauge 两种指标类型
- ✅ **标签支持** - 支持多维度标签，便于数据聚合
- ✅ **兼容性好** - 与 oracledb_exporter 语法兼容

### 工作原理

```
custom_queries.metrics → SQL 执行 → 结果转换 → Prometheus 指标
```

## 快速开始

### 步骤 1：在数据源中启用自定义指标

编辑 `dameng_exporter.toml`，为目标数据源开启自定义指标并指定文件路径：

```toml
[[datasource]]
name = "dm_prod"
dbHost = "192.168.1.100:5236"
dbUser = "SYSDBA"
dbPwd = "SYSDBA"
# 开启以下两个参数
registerCustomMetrics = true
customMetricsFile = "./custom_queries.metrics"  # 支持相对/绝对路径
```

> `registerCustomMetrics` 默认为 `true`，如需禁用自定义指标可显式设置为 `false`。`customMetricsFile` 必须指向实际存在的 `.metrics`、`.sql.toml` 或 `.queries.toml` 文件。

### 步骤 2：创建自定义指标文件

在 Exporter 工作目录创建 `custom_queries.metrics`（或自定义命名的支持格式）并设置合适权限：

```bash
touch custom_queries.metrics
chmod 644 custom_queries.metrics
```

### 步骤 3：添加第一个指标定义

```toml
[[metric]]
context = "database_size"
request = """
SELECT /*+DAMENG_EXPORTER*/
       ROUND(SUM(BYTES / 1048576 / 1024), 2) AS size_gb
FROM   DBA_DATA_FILES
"""
metricsdesc = { size_gb = "Database total size in GB" }
metricstype = { size_gb = "gauge" }
# ignorezeroresult = true  # 可选：忽略为 0 的结果
```

### 步骤 4：重新启动并验证

保存上述配置后重启 Exporter 或容器，确认日志出现 `loaded X custom metric(s)`。然后访问 metrics 端点检查指标：

```bash
curl http://localhost:9200/metrics | grep dmdbms_database_size
# 示例输出: dmdbms_database_size_size_gb{datasource="dm_prod"} 1024.5
```

## 配置文件格式

### 基本结构

```toml
# 每个 [[metric]] 定义一个指标组
[[metric]]
context = "指标上下文名称"
request = "SQL 查询语句"
metricsdesc = { 列名 = "指标描述" }

# 可选参数
labels = ["标签列名1", "标签列名2"]
metricstype = { 列名 = "counter|gauge" }
```

### 参数详解

#### 必填参数

| 参数 | 类型 | 说明 | 示例 |
|-----|------|------|------|
| `context` | string | 指标上下文，作为指标名称的一部分 | `"user_activity"` |
| `request` | string | SQL 查询语句 | `"SELECT COUNT(*) as count FROM V$SESSIONS"` |
| `metricsdesc` | map | 指标列的描述信息 | `{ count = "Active session count" }` |

#### 可选参数

| 参数 | 类型 | 默认值 | 说明 | 示例 |
|-----|------|--------|------|------|
| `labels` | array | `[]` | 作为标签的列名 | `["username", "status"]` |
| `metricstype` | map | `gauge` | 指标类型定义 | `{ total = "counter" }` |
| `ignorezeroresult` | bool | `false` | 是否忽略零值结果 | `true` |

### 指标命名规则

最终的 Prometheus 指标名称格式：
```
dmdbms_{context}_{column_name}
```

例如：
- context = `"session"`
- column = `"active_count"`
- 指标名 = `dmdbms_session_active_count`

## 实用示例

### 基础示例

#### 1. 简单计数指标

```toml
[[metric]]
context = "simple_count"
request = "SELECT /*+DAMENG_EXPORTER*/ COUNT(*) as total FROM V$SESSIONS"
metricsdesc = { total = "Total session count" }
```

#### 2. 带标签的指标

```toml
[[metric]]
context = "session_by_state"
labels = ["state_type"]
request = """
SELECT /*+DAMENG_EXPORTER*/
    DECODE(STATE, NULL, 'TOTAL', STATE) AS state_type,
    COUNT(SESS_ID) AS count
FROM V$SESSIONS
WHERE STATE IN ('IDLE', 'ACTIVE')
GROUP BY ROLLUP(STATE)
"""
metricsdesc = { count = "Session count by state" }
```

#### 3. 多值指标

```toml
[[metric]]
context = "database_stats"
request = """
SELECT /*+DAMENG_EXPORTER*/
    (SELECT COUNT(*) FROM V$SESSIONS WHERE STATE = 'ACTIVE') as active_sessions,
    (SELECT COUNT(*) FROM V$LOCK WHERE BLOCKED=1) as blocked_locks,
    (SELECT COUNT(*) FROM V$TRXWAIT) as trx_waits,
    (SELECT COUNT(*) FROM V$THREADS) as thread_count
FROM DUAL
"""
metricsdesc = { 
    active_sessions = "Active sessions",
    blocked_locks = "Blocked locks",
    trx_waits = "Transaction waits",
    thread_count = "Thread count"
}
```

### 性能监控

#### 1. 表空间使用率监控

```toml
[[metric]]
context = "tablespace_usage"
labels = ["tablespace_name"]
request = """
SELECT /*+DAMENG_EXPORTER*/ 
    F.TABLESPACE_NAME as tablespace_name,
    T.TOTAL_SPACE as total_mb,
    T.TOTAL_SPACE - F.FREE_SPACE as used_mb,
    F.FREE_SPACE as free_mb,
    ROUND((T.TOTAL_SPACE - F.FREE_SPACE) * 100.0 / T.TOTAL_SPACE, 2) as used_percent
FROM (
    SELECT TABLESPACE_NAME, 
           ROUND(SUM(BLOCKS * (SELECT PARA_VALUE / 1024 FROM V$DM_INI WHERE PARA_NAME = 'GLOBAL_PAGE_SIZE') / 1024)) FREE_SPACE
    FROM DBA_FREE_SPACE
    GROUP BY TABLESPACE_NAME
) F,
(
    SELECT TABLESPACE_NAME, 
           ROUND(SUM(BYTES / 1048576)) TOTAL_SPACE
    FROM DBA_DATA_FILES
    GROUP BY TABLESPACE_NAME
) T
WHERE F.TABLESPACE_NAME = T.TABLESPACE_NAME
"""
metricsdesc = {
    total_mb = "Tablespace total size in MB",
    used_mb = "Tablespace used size in MB", 
    free_mb = "Tablespace free size in MB",
    used_percent = "Tablespace usage percentage"
}
```

#### 2. SQL 执行统计

```toml
[[metric]]
context = "sql_statistics"
request = """
SELECT /*+DAMENG_EXPORTER*/ 
    NAME,
    STAT_VAL
FROM V$SYSSTAT 
WHERE NAME IN (
    'select statements',
    'insert statements',
    'delete statements',
    'update statements',
    'ddl statements',
    'transaction total count',
    'DB time(ms)',
    'parse time(ms)',
    'hard parse time(ms)',
    'logic read count',
    'physical read count',
    'physical write count'
)
"""
labels = ["name"]
metricsdesc = {
    stat_val = "SQL execution statistics value"
}
metricstype = {
    stat_val = "counter"
}
```

#### 3. 缓冲池命中率

```toml
[[metric]]
context = "buffer_pool_stats"
labels = ["pool_name"]
request = """
SELECT /*+DAMENG_EXPORTER*/ 
    NAME as pool_name,
    ROUND(SUM(RAT_HIT) / COUNT(*), 4) as hit_ratio
FROM V$BUFFERPOOL 
WHERE NAME = 'FAST' 
GROUP BY NAME
"""
metricsdesc = {
    hit_ratio = "Buffer pool hit ratio"
}
```

#### 4. 慢查询监控

```toml
[[metric]]
context = "slow_queries"
request = """
SELECT /*+DAMENG_EXPORTER*/ 
    COUNT(*) as slow_count,
    AVG(EXEC_TIME) as avg_time,
    MAX(EXEC_TIME) as max_time
FROM (
    SELECT DATEDIFF(MS, LAST_RECV_TIME, SYSDATE) as EXEC_TIME
    FROM V$SESSIONS
    WHERE STATE = 'ACTIVE'
        AND DATEDIFF(MS, LAST_RECV_TIME, SYSDATE) >= 5000
        AND LAST_RECV_TIME > TO_TIMESTAMP('2000-01-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
)
"""
metricsdesc = {
    slow_count = "Current slow query count",
    avg_time = "Average slow query time in ms",
    max_time = "Maximum slow query time in ms"
}
```

### ignorezeroresult 参数详解

`ignorezeroresult` 参数用于过滤掉值为零的指标，这在处理稀疏数据时特别有用。

#### 使用场景

1. **减少无意义的零值指标**
   - 大量用户但只有少数活跃
   - 多个模块但只有部分有错误
   - 监控特定事件的发生

2. **优化 Prometheus 性能**
   - 减少时间序列数量
   - 降低存储空间占用
   - 提升查询速度

#### 示例：用户活动监控

```toml
[[metric]]
context = "user_activity"
labels = ["username", "activity_type"]
request = """
SELECT 
    username,
    activity_type,
    activity_count
FROM user_activity_stats
WHERE date = CURRENT_DATE
"""
metricsdesc = { activity_count = "User activity count" }
ignorezeroresult = true  # 只显示有活动的用户
```

**不使用 ignorezeroresult（默认）**：
```
dmdbms_user_activity_activity_count{username="user1",activity_type="login"} 5
dmdbms_user_activity_activity_count{username="user2",activity_type="login"} 0
dmdbms_user_activity_activity_count{username="user3",activity_type="login"} 0
dmdbms_user_activity_activity_count{username="user4",activity_type="login"} 3
# 包含所有用户，即使没有活动
```

**使用 ignorezeroresult = true**：
```
dmdbms_user_activity_activity_count{username="user1",activity_type="login"} 5
dmdbms_user_activity_activity_count{username="user4",activity_type="login"} 3
# 只显示有活动的用户，过滤掉零值
```

#### 示例：错误监控

```toml
[[metric]]
context = "module_errors"
labels = ["module_name", "error_type"]
request = """
SELECT 
    module_name,
    error_type,
    error_count
FROM v$module_error_stats
WHERE time_window = 'LAST_HOUR'
"""
metricsdesc = { error_count = "Module error count in last hour" }
ignorezeroresult = true  # 只报告有错误的模块
```

这样配置后，只有发生错误的模块才会产生指标，避免大量零值污染监控数据。

#### 注意事项

1. **默认值为 false**：不过滤零值，保持向后兼容
2. **适用于稀疏数据**：当大部分值为零时效果最佳
3. **不影响 NULL 值**：NULL 值会被转换为 0，然后根据设置决定是否过滤
4. **日志记录**：启用 debug 日志级别可以看到被过滤的指标

## 常见问题

### Q1: 指标没有出现在 /metrics 端点

**可能原因：**
1. SQL 语法错误
2. 权限不足
3. 配置文件格式错误

**解决方法：**
```bash
# 检查日志
tail -f logs/dameng_exporter.log | grep custom

# 验证 SQL
./dameng_exporter --test-custom-metrics

# 检查权限
GRANT SELECT ON target_table TO prometheus_user;
```

### Q2: 指标值始终为 0

**可能原因：**
1. SQL 返回空结果集
2. 类型转换错误
3. ignorezeroresult 设置问题

**解决方法：**
```toml
# 确保返回非空值
[[metric]]
context = "safe_count"
request = """
SELECT COALESCE(COUNT(*), 0) as count 
FROM table_name
"""

# 如果希望过滤掉零值指标
ignorezeroresult = true
```

### Q3: 标签值显示为 null

**可能原因：**
1. 标签列返回 NULL 值
2. 列名大小写不匹配

**解决方法：**
```toml
# 处理 NULL 值
[[metric]]
labels = ["category"]
request = """
SELECT 
    COALESCE(category, 'unknown') as category,
    COUNT(*) as count
FROM products
GROUP BY category
"""
```

### Q4: 性能影响过大

**可能原因：**
1. 查询过于复杂
2. 扫描数据量过大
3. 缺少索引

**解决方法：**
```toml
# 优化查询
[[metric]]
context = "optimized_stats"
request = """
SELECT /*+ FIRST_ROWS(10) */
    category,
    COUNT(*) as count
FROM (
    SELECT category 
    FROM products 
    WHERE created_date > SYSDATE - 1
) 
GROUP BY category
"""
```

### Q5: Counter 类型指标不递增

**可能原因：**
1. 查询返回的不是累计值
2. 类型定义错误

**解决方法：**
```toml
# Counter 应返回累计值
[[metric]]
context = "total_transactions"
request = """
SELECT 
    SUM(transaction_count) as total  -- 累计值
FROM daily_stats
"""
metricstype = { total = "counter" }

# 而不是
request = """
SELECT 
    COUNT(*) as count  -- 当前值
FROM transactions
WHERE date = TODAY
"""
```
