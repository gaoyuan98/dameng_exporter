
# 达梦数据库监控采集器多数据源支持改造方案（执行版 v1.2）

> **本版说明**：在不改变总体目标的前提下，对任务进行了**更细粒度的可执行拆分（WBS/TODO）**，并将「**热重载与注册安全**」「**抓取超时对齐**」移至文档末尾的**后续计划**（当前版本不实现，仅做设计占位）。

---

## 一、现状分析（摘录）

- 单一数据源连接，全局共享 DBPool，无法监控多个实例。
- 配置文件结构简单，仅支持单个数据库。
- 所有采集器依赖同一连接，故障影响面大，日志难以定位到具体数据源。
- 核心文件（现状）：`config/config.go`（单库配置）、`db/db.go`（单一 DBPool）、`dameng_exporter.go`（构建单一 DSN）。

> 以上为原始现状摘要；详述与上下文保留在历史版本中。

---

## 二、多数据源架构设计（巩固与微调）

### 2.1 配置文件格式（TOML）
- **保持多数据源结构**：全局系统项 + `[[datasource]]` 列表。
- **全面属性下沉**：连接池、慢 SQL、缓存、自定义指标文件等均按数据源维度配置。
- **密码机制**：保持 `ENC(base64)` 兼容；（可选）支持明文用于测试环境。

**示例（与旧版兼容，略有整理）：**
```toml
# 全局（系统级，不下沉）
listenAddress = ":9200"
metricPath    = "/metrics"
version       = "v1.2.0"
logLevel      = "info"
logMaxSize    = 10
logMaxBackups = 3
logMaxAge     = 30
encodeConfigPwd = true

# 全局 Basic Auth
enableBasicAuth   = true
basicAuthUsername = "admin"
basicAuthPassword = "ENC(encrypted_admin_pwd)"

# 采集策略（当前版保留原有混合策略参数）
collectStrategy     = "hybrid"
maxConcurrentGroups = 3
groupTimeout        = 60

# —— 数据源 ——
[[datasource]]
name = "prod-master"
dbHost = "127.0.0.1:5236"
dbUser = "SYSDBA"
dbPwd  = "ENC(base64_encrypted_password1)"
queryTimeout = 30
maxOpenConns = 10
maxIdleConns = 2
connMaxLifetime = 30
bigKeyDataCacheTime = 60
alarmKeyCacheTime   = 5
checkSlowSQL    = true
slowSqlTime     = 10000
slowSqlMaxRows  = 10
registerHostMetrics     = false
registerDatabaseMetrics = true
registerDmhsMetrics     = false
registerCustomMetrics   = true
priority = 1
labels   = "cluster=prod,role=master,zone=beijing"
customMetricsFile = "./custom_metrics_prod_master.toml"

[[datasource]]
name = "prod-slave1"
dbHost = "192.168.1.100:5236"
dbUser = "SYSDBA"
dbPwd  = "ENC(base64_encrypted_password2)"
queryTimeout = 20
maxOpenConns = 5
maxIdleConns = 1
connMaxLifetime = 20
bigKeyDataCacheTime = 30
alarmKeyCacheTime   = 3
checkSlowSQL = false
registerHostMetrics     = false
registerDatabaseMetrics = true
registerDmhsMetrics     = false
registerCustomMetrics   = false
priority = 2
labels   = "cluster=prod,role=slave,zone=beijing"
customMetricsFile = "./custom_metrics_prod_slave.toml"

[[datasource]]
name = "test-db"
dbHost = "192.168.1.200:5236"
dbUser = "SYSDBA"
dbPwd  = "password3"     # 测试环境允许明文
queryTimeout    = 15
maxOpenConns    = 3
maxIdleConns    = 1
connMaxLifetime = 15
bigKeyDataCacheTime = 10
alarmKeyCacheTime   = 1
checkSlowSQL  = true
slowSqlTime   = 1000
slowSqlMaxRows = 20
registerHostMetrics     = true
registerDatabaseMetrics = true
registerDmhsMetrics     = true
registerCustomMetrics   = true
priority = 3
labels   = "cluster=test,role=master,zone=shanghai"
customMetricsFile = "./custom_metrics_test.toml"
enabled = true
description = "测试环境主库"
```

**单数据源兼容（自动转为 `[[datasource]]`）**：保留原有逻辑。

### 2.2 混合采集策略（保留）
- 高/中/低优先级分组 + 串行/并发/混合策略。

### 2.3 核心组件
- **DBPoolManager**：多数据源连接池 + 健康检查（定时 `PingContext`）。
- **日志增强**：统一在日志中注入 `datasource=<name>` 维度，便于定位。
- **标签注入（修正）**：取消“事后给 Metric 加标签”的做法，改为在 `Desc` 层固化 const labels（如 `datasource`、`cluster`），并在采集时通过 `MustNewConstMetric(desc, ...)` 产出样本。

> 注：本版**不实现**“热重载与注册安全”“抓取超时对齐”，相关设计移至文档末尾“后续计划”。

---

## 三、详细实施计划（更细粒度 TODO / WBS）

> 目标：将工作拆分为**可交付、可验收**的最小任务单元，每一项有明确产出与 DoD（Definition of Done）。

### 里程碑 M0：准备与基线（0.5 天）
- [ ] 建立分支 `feature/multi-datasource-v1_2`
- [ ] 引入 `make test` / `make lint` / `go test -race` 基线
- [ ] 设定日志格式与目录结构约定（`/config`, `/db`, `/collector`, `/logger`）
- **DoD**：CI 通过；空项目可编译启动（打印“starting exporter”）。

### 里程碑 M1：配置层（1.5 天）
**M1‑1 结构与解析**
- [ ] `config/multi_config.go`：定义 `MultiSourceConfig`、`DataSourceConfig`
- [ ] TOML 解析与映射；支持 `[[datasource]]` 多段
- [ ] 单库→多库兼容转换（自动生成 `[[datasource]] name="default"`）

**M1‑2 默认值与校验**
- [ ] `config/defaults.go`：默认值（超时/连接池/注册开关/优先级等）
- [ ] `ApplyDefaults()` 覆盖空值
- [ ] `config/validation.go`：必填/范围/文件存在性校验，输出**可读错误**

**M1‑3 密码机制**
- [ ] `EncodeConfigPwd` 扩展：批量处理所有 `dbPwd`
- [ ] 加载时自动识别 `ENC(base64)` 并解码；测试环境允许明文

**DoD**
- [ ] 使用示例 `multi_datasource.toml` 成功加载并打印结构摘要（不连接 DB）
- [ ] 对错误配置给出清晰报错并退出码 `!=0`

### 里程碑 M2：连接池与健康检查（2 天）
**M2‑1 连接池管理**
- [ ] `db/pool_manager.go`：`DBPoolManager{pools, groups, ...}`
- [ ] 连接创建、MaxOpen/MaxIdle/ConnMaxLifetime 应用
- [ ] 连接字符串构建工具（DbHost/User/Pwd → DSN）

**M2‑2 健康检查与日志**
- [ ] `db/health_check.go`：定时 `PingContext`，状态：`Healthy/Unhealthy/Disabled`
- [ ] `logger/multi_source_logger.go`：`DataSourceLogger` 注入 `datasource` 字段

**DoD**
- [ ] 可启动但不注册采集器；日志周期性打印健康状态
- [ ] 某数据源失败不影响其他源创建/心跳

### 里程碑 M3：采集器基类与标签（2 天）
**M3‑1 采集器基类**
- [ ] `collector/base_multi_collector.go`：基类 + 混合策略调度骨架
- [ ] 错误处理与最小并发（按组/源串并行）

**M3‑2 标签与 `Desc`**
- [ ] `collector/desc_factory.go`：为每个数据源构建带 const labels 的 `Desc`
- [ ] 替换旧的“事后标签注入”逻辑

**M3‑3 验证型采集器**
- [ ] 实现 1 个简单内置采集器（例如会话数），验证多源 + 标签

**DoD**
- [ ] `/metrics` 可暴露上述基础指标；包含 `datasource` 标签
- [ ] 压测 3 个数据源抓取无 crash

### 里程碑 M4：内置采集器迁移（3 天）
- [ ] `db_system_info_collector.go`
- [ ] `db_tablespace_info_collector.go`
- [ ] `db_sessions_status_collector.go`
- [ ] `db_slow_sql_info_collector.go`
- [ ] 其余采集器（按优先级逐个迁移）
- **DoD**：所有原有指标均可在多源下工作，日志带 `datasource`。

### 里程碑 M5：自定义指标（2 天）
**M5‑1 解析与路由**
- [ ] `custom_collector.go`：按数据源加载各自 `custom_metrics_*.toml`
- [ ] 解析字段：`context`/`labels`/`request`/`metricsdesc`/`metricstype`

**M5‑2 安全与限额（基础版）**
- [ ] 只读校验（仅允许 `SELECT`）
- [ ] 行数上限（默认 100）；超限截断并打告警日志
- [ ] 采集超时（使用数据源 `queryTimeout`）

**DoD**
- [ ] 三份示例文件（prod master/slave, test）加载并产出指标
- [ ] 错误 SQL 不影响其他数据源与其他指标

### 里程碑 M6：主程序集成与发布物（1 天）
- [ ] `dameng_exporter.go`：整合池管理 + 采集器注册 + HTTP 暴露
- [ ] 保留 BasicAuth；**不包含热重载与抓取超时对齐**
- [ ] README/部署示例/示例配置文件
- **DoD**：二进制可运行；Prometheus 可抓取；最小生产可用。

### 里程碑 M7：测试与质量（并行穿插，最终 1 天）
- [ ] 单元测试：配置解析/默认值/校验/连接池构建/自定义解析
- [ ] 集成测试：3 源 + 常用采集器 + 自定义指标
- [ ] `go test -race`、基准若干（可选）
- **DoD**：主线覆盖率达目标（例如 ≥60%），关键路径均有测试。

---

## 四、技术风险与应对（保持）
- 性能：限制连接池规模，优先从库采集，必要时提升抓取间隔。
- 内存：控制连接池与结果集大小，避免一次性载入大量行。
- 复杂度：以里程碑逐步交付，确保每步可回滚。

---

## 五、自定义指标与日志（保持并微调）

### 5.1 自定义指标建议
- 生产主库：关注业务核心表/性能 KPI；从库：复制延迟与状态；测试：用例/基准。
- 每个数据源独立 `custom_metrics_*.toml`，相互隔离。

### 5.2 日志样例
- 统一输出 `[datasource=<name>]`，并包含具体文件路径与 SQL 片段（必要时脱敏）。

---

## 六、关键代码文件清单（本版）
**新增**
- `config/multi_config.go`、`config/defaults.go`、`config/validation.go`
- `db/pool_manager.go`、`db/health_check.go`
- `collector/base_multi_collector.go`、`collector/desc_factory.go`、`collector/strategy.go`
- `logger/multi_source_logger.go`
- `multi_datasource.toml`、`custom_metrics_*.toml` 示例

**修改**
- `config/config.go`、`db/db.go`、`dameng_exporter.go`、`collector/*.go`

> 注：`config/hot_reload.go` 在当前版本**不实现**；见后续计划。

---

## 七、验收标准（执行版）
**功能**
- [ ] 支持多数据源，单库配置自动兼容转换
- [ ] 混合策略调度；每个数据源可独立开关采集器
- [ ] 所有内置指标带 `datasource` 标签；自定义指标按源加载

**可靠性**
- [ ] 任意一个数据源异常不影响其他源采集
- [ ] 连接池健康检查与告警日志生效
- [ ] 配置错误可读且快速失败

**性能（基线）**
- [ ] 3 源并发时采集延时在可控范围（参考线：不超过单源 1.5 倍）
- [ ] 内存占用随源数线性增长，无明显尖刺

---

## 八、后续计划（Roadmap，仅设计占位）

> **以下两项不在本版本交付范围内**，将在后续版本评估与支持：

### 8.1 热重载与注册安全（计划支持）
- 设计要点：**每数据源独立 `Registry` + `prometheus.Gatherers` 聚合**；重载时**新建**整套 `Registry/Collectors`，通过 `atomic.Value` **原子切换**；暴露 `POST /-/reload`（需鉴权）；重载失败回退旧配置。

### 8.2 抓取超时对齐（计划支持）
- 设计要点：读取 `X-Prometheus-Scrape-Timeout-Seconds`，以 `0.8×` 作为统一 deadline 透传到采集链路，保证端到端不超时；`promhttp` 侧启用 `ContinueOnError` 以保留成功样本。

> 实现细节与代码骨架将在 Roadmap 里进一步补充，待当前版本稳定后排期。

---

## 九、交付物清单
- 源码：上述文件与目录结构
- 示例：`multi_datasource.toml` 与三套 `custom_metrics_*.toml`
- 文档：README（部署与配置说明）、本方案（执行版）
- 二进制：`dameng_exporter_v1.2.0`（Linux/amd64 等）

